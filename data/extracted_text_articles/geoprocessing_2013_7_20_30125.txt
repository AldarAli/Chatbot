TerraHidro: A Distributed Hydrology Modelling System With High Quality 
Drainage Extraction 
 
 
Sergio Rosim, João Ricardo de Freitas Oliveira, Alexandre Copertino Jardim, Laércio Massaru Namikawa,  
Camilo Daleles Rennó 
Image Processing Division 
National Institute for Space Research 
São José dos Campos, Brazil 
{sergio, joao, camilo, laercio, alexandre}@dpi.inpe.br 
 
Abstract—This paper presents the current development stage 
of TerraHidro, a Distributed Hydrology Modeling System 
created to design Geographic Information Systems (GIS) 
applications for water flow in hydrographical basins. 
TerraHidro proposes a different computational representation 
to deal with water flow in GIS applications. At first, this paper 
presents the conceptual model of TerraHidro, where the 
structure used to develop applications is independent from the 
structures used to extract local flow paths. Since the local flows 
are primary information for network drainage extractions, the 
Priority First Search (PFS) method used by TerraHidro to 
extract these local flows is presented here. PFS method also 
gives realistic results in flat areas and eliminates all spurious 
pits in the DEM data with small modifications in the elevation 
values. Examples of drainage networks are presented and a 
comparison between TerraHidro and ArcGIS Hydro Tools are 
presented. 
Keywords; local flow; distributed hydrological models; PFS 
method; drainage network. 
 
I. 
 INTRODUCTION 
The local flow distribution in a water basin is the most 
important factor in order to model distributed hydrological 
systems that aim at hydrological resources management. The 
underlying premise is that terrain topography is the main 
landscape contributor in defining these local flows [1][2]. 
Mathematical representations of terrain topography and sets 
of functions to extract superficial local water flow have been 
explored by GIS users for a long time. The basis for terrain 
topography representation in GIS is to partition the region 
extents. A Cell is the unit of this partition set and the local 
flow is the water flow for each cell considering the status of 
its neighbor cells according to a specific chosen 
neighborhood rule. 
The most common data structures found in GIS libraries 
and systems for terrain representation dedicated to 
hydrological modeling are the DEM (Digital Elevation 
Model - DEM) [3] with regular grids, Irregular Triangular 
Networks – TIN [4], Contour Lines based representation [5], 
and Irregular Polygons Tessellations [6]. Each chosen 
surface representation carries its own local water flow 
extraction functions and its own local flow data structure. 
The local flow representation is dependent of the data 
structure used to represent the terrain topography. For 
instance, DEM local flow extraction uses the 8-neighbor 
concept and creates a local flow representation, called Local 
Drain Direction (LDD) [3]. It is stored in the same structure 
DEM, forming a regular grid of local flow directions. 
This situation takes hydrological modeling to a condition 
where there is a strong coupling between the quality of the 
local flow representation and the parameters for the used 
terrain data structure, in particular its spatial resolution with 
direct implications on the model outcomes [7]. Distributed 
hydrological modeling environments normally assume a 
unique data structure for terrain representation. This may 
simplify software development but it can’t make use of the 
properties of the other terrain data structures. The concept 
proposed by the TerraHidro [8][9][10][11], a distributed 
hydrological system, assists the simplification of software 
development and at the same time allows the use of different 
terrain data structures. In this way, the decoupling of terrain 
data structure and local flow data structure eliminates the 
need to code a given operator for each one of the used terrain 
structures [8]. 
Currently, TerraHidro works only with DEM structure to 
extract and develop applications and it is a plugin of the 
geographic visualizer TerraView that loads and stores data in 
a geographical library called TerraLib [2], an open source 
geographical library implemented in C++ language that has 
been developing at the Image Processing Division of 
National Institute for Space Research, in São José dos 
Campos a Brazil city situated in the São Paulo region. This 
approach has allowed TerraHidro project team of designers 
and programmers keep focused on the development of 
system functionality of TerraHidro. TerraView main goal is 
to make available to the GIS Community an easy geographic 
data viewer with resources that include database queries and 
data analysis, exemplifying the use of the TerraLib library. 
161
Copyright (c) IARIA, 2013.     ISBN:  978-1-61208-251-6
GEOProcessing 2013 : The Fifth International Conference on Advanced Geographic Information Systems, Applications, and Services

TerraLib is an open-source GIS software library. TerraLib 
supports coding of geographical applications using spatial 
databases, and stores data in different DBMS including 
MySQL, PostgreSQL and  other databases. Figure 1 shows 
relationship among Terrahidro, TerraView and TerraLib. 
 
Figure 1 TerraHidro, TerraView and TerraLib relationship 
 
The focus of TerraHidro development has been to obtain 
the best quality for each generated result. Optimizations, 
such as reducing processing time, are considered whenever 
they are not detrimental to the results quality. 
This paper is structured as follows: Section two describes 
the steps required to obtain the drainage network, Section 
three presents the method used by TerraHidro to define the 
local flows, Section four shows the results obtained, and 
Section five has the conclusions. 
 
II. 
DRAINAGE EXTRACTION AND BASIN DELIMITATION 
Drainage has been used for several applications involving 
water resources. To extract the drainage, first of all, the local 
flow and the accumulation area must be determined. Local 
flow is a flow between two neighbor cells considering the 
steepest downstream path among a cell and each of its eight 
neighbor cells. Figure 2 shows this concept. 
 
 
Figure 2 Local flow extraction to X cell 
After this step, the accumulation areas are calculated 
from the local flows. Each Y cell receives a value that is the 
size of the area of all cells that are on the path arriving at Y 
cell. The next step requires the definition of the accumulation 
area subset called drainage network. The user defines a 
threshold value and all grid cells with values equal or greater 
than this threshold value are defined as drainage cells. At this 
point, TerraHidro can define the river reaches that delineate 
the drainage segments. The segments are between the water 
sources and junctions, between junctions, and between 
junctions and drainage mouth. Basin delimitation, the next 
processing step, can be executed by selecting one or more 
points on the drainage. TerraHidro finds the basin for each 
given point or for each river reach. In the end, the basins can 
be used as grid cell, as vector forms. Figures 3, and 4 present 
this concept. Figure 3 has drainage network segments. Each 
segment is represented by a different color. Figure 4 shows 
the watershed for each segment. 
III. 
PFS AND OTHER DRAINAGE EXTRACTION METHODS 
The extracted drainage is the basic information to 
develop hydrological applications. For this reason, the 
method used to extract the drainage must minimize the 
effects of errors from DEM generation, such as the ones 
present in the Shuttle Radar Topographic Mission (SRTM) 
data set with 90 meters of horizontal resolution is used in this 
work. Although the SRTM data is used worldwide, it 
contains a large number of spurious pits among other 
problems. Spurious pits are false end points of flow. The 
drainage extraction should ensure that the drainage is 
connected in the adopted resolution with small changes in 
the original SRTM values, generating the most real drainage 
possible. 
 
 
 
Figure 3 River segments. 
Given that the core of water resource applications are 
drainage networks, the drainage extraction method used by 
TerraHidro will be described in the next section. 
 
162
Copyright (c) IARIA, 2013.     ISBN:  978-1-61208-251-6
GEOProcessing 2013 : The Fifth International Conference on Advanced Geographic Information Systems, Applications, and Services

 
 
Figure 4 Watersheds delimitation. Each watershed corresponds one river 
segment. 
TerraHidro uses two approaches to solve the spurious 
pits problem. In the first one, the mean is calculated for each 
pit using the neighborhood 8 of the pit. If the pit remains, or 
generates a new pit in one of the neighbors, their value is not 
replaced by the mean, and then it uses the PFS method to 
solve the problem [12]. The basic idea of this method is to 
link a pit with a nearby grid cell with lower elevation 
creating a optimum path between both cells. Next step is to 
define a new elevation value for each grid cell in this path 
creating a monotonic down slope from pit cell to lower 
elevation cell. By applying the method for every pit, PFS 
creates a fully connected drainage network generating 
elevation value changes only in the path. Figure 4 shows the 
diagram of TerraHidro method to eliminate pits. PFS has 
presented better results when compared with others methods 
according studies made in [13]. Figure 5 shows the diagram 
of TerraHidro method to eliminate pits. 
 
 
 
Figure 5 Pit removal schema. 
The pit removal schema follows the sequence presented 
below: 
(a) In the first step, the SRTM data set is inserted into the 
TerraHidro system. Next, the user chooses between two 
paths: either create drainage in the flat regions and then 
proceed to the pit elimination or proceed directly to eliminate 
the pits. 
(b) SRTM creates spurious flat areas on large water 
bodies. TerraHidro recognizes and delimits these areas to be 
used in the carving processes. This step is necessary because 
PFS method don't produce good results in the flat areas [14]. 
(c) The carving process creates a down path slope from 
the border of the flat area until reaching the center of this 
area. This is executed for every point on the border of the flat 
area. The drainage flows at the center of the flat area.  Figure 
6 shows the schematic representation of the carving process 
and Figure 7 presents two real geographical areas in the 
Brazilian Amazon region. The water body areas were 
highlighted with yellow ellipses to exemplify this type of 
case. 
 
 
 
Figure 6 (a) Plane area delimited; (b), (c) intermediate carving processes; 
(d) water body carved with water flow path (red line). 
 
 
 
Figure 7 Drainage networks of plane areas (yellow ellipses) (a) Purus basin 
and (b), (c) Tapajós basin. 
(d) For each grid C cell of altimetry that contains a pit, 
TerraHidro calculates the mean values of its eight 
163
Copyright (c) IARIA, 2013.     ISBN:  978-1-61208-251-6
GEOProcessing 2013 : The Fifth International Conference on Advanced Geographic Information Systems, Applications, and Services

neighboring cells. If this procedure does not create a new pit 
in this neighborhood, the value computed is assigned to C 
cell, thus eliminating the pit. Otherwise, the pit of the C cell 
remains. Figure 8 presents an example of this pit removal 
procedure. 
 
 
 
Figure 8 Pit removal by 8-neighbourhood media average calculus. (a) 
Without generating new pit; (b) generating new pit.. 
(e) Pits that are not removed by the mean calculation 
procedure are eliminated using Priority First Search - PFS 
method. This method finds a path between a pit and a nearby 
grid cell with lower elevation. For each neighboring cell of 
the one containing the initial pit, the differences between 
elevation values are calculated and stored in a queue. The 
path to the smallest value is selected. When there are equal 
differences for more than one neighbor, the cell that is 
closest to the one that contains the pit will be selected. The 
process is repeated from the selected cell. The minimum 
distance is always calculated in relation to the position of the 
cell containing the initial pit when points differences are tied. 
At this point, the new elevation value for each cell belonging 
to the path between the two pits is calculated accordingly to 
its distance from these pits. Figure 9 shows this procedure. 
 
 
Figure 9 Carving processes to eliminate pits. (a) Initial pit identification 
(red color); (b) path found by PFS method (final pit in green color). 
The modified PFS method eliminates all the pits in the 
existing elevation grid ensuring flow inside the entire study 
region. 
 
IV. 
RESULTS 
TerraHidro has been used in large geographical areas. 
The focus has been to test TerraHidro in actual extensive 
watershed areas using computers  with typical RAM memory 
capacity, for example, 3 GB. TerraHidro has extracted 
drainage networks successfully for the test areas eliminating 
all pits. This qualifies TerraHidro as a robust system, giving 
also very good results in terms of drainage network 
extraction and watershed delimitation. Amazonian and sub 
Amazonian basins and South America  region have been 
used  by TerraHidro to extract drainage networks, using the  
SRTM data set with 90 meters spatial resolution.  
Figure 10 shows the drainage network for the Taquaruçu 
River basin region. The DEM of this region has 2.024 rows, 
1.875 columns (3.734.280 image size) and 396.769 pits. 
 
 
 
Figure 10 Drainage network of Taquaruçu basin (red color)green). 
Figure 11 Presents results of the drainage extraction of 
Xingu River region, another Amazon sub basin. The 
information of this DEM is: 15.962 rows, 7.202 columns 
(144.958.324 image size)) and 6.472.113 pits. The image on 
the right side is the zoomed area in of the yellow rectangle in 
the image on the left side. 
The next watershed is the Tapajós River Amazon sub 
basin, which can be seen in Figure 12. This region has 
19.201 rows, 9.601 columns (184.348.801 image size) and 
8.647.984 pits. In the image on the right side, it is possible to 
see the carving in the plane area into the river (up to down in 
the middle of image). 
Figure 13 presents Purus River, that is another 
Amazonian sub basin. Also here it is possible to see the 
drainage flowing by the middle of the large rivers correcting 
these plane areas.  The data of the Purus River basin are: 
12.000 rows, 15.600 columns (187.2000.000 cells) and 
13.279.394 pits. 
 
164
Copyright (c) IARIA, 2013.     ISBN:  978-1-61208-251-6
GEOProcessing 2013 : The Fifth International Conference on Advanced Geographic Information Systems, Applications, and Services

 
 
Figure 11 Drainage network of Xingu basin. 
 
 
 
 
Figure 12 Drainage network of Tapajós basin. 
 
 
 
 
Figure 13 Drainage network of Purus basin. 
The last Amazon sub basin processed by TerraHidro was 
the Tocantins River basin. Figure 14 shows the drainage 
extracted by TerraHidro from a region with 21.602 rows, 
14.402 columns (311.112.004 image size)) and 15.893.139 
pits. 
 
 
 
Figure 14 Drainage network of Tocantins basin. 
The whole Amazon basin was also processed. Figure 15 
shows in red color the delimitation of this basin. In green 
color, it is possible to see part of the Amazon basin river 
network. The data of the Purus River basin are: 32,400 rows, 
38,400 columns (1,244,160,000) and 65,670,466 pits. 
 
 
 
Figure 15 Drainage network of Amazonian basin. 
The whole South America region was also processed. 
Figure 16 presents the drainage networks with the most 
important South American rivers. The information of the 
DEM are: 60.001 rows, 84,001 columns (5,040,144,001 
image size) and 161.135.443 pits. 
 
165
Copyright (c) IARIA, 2013.     ISBN:  978-1-61208-251-6
GEOProcessing 2013 : The Fifth International Conference on Advanced Geographic Information Systems, Applications, and Services

 
 
Figure 16 Drainage network of South America region. 
Drainage networks have also been extracted for the 
African countries of Somalia, Kenya and South Sudan. 
Figures 17, 18 and 19 show the drainage (blue color) and the 
corresponding watersheds for each drainage segment. 
 
 
 
Figure 17 Drainage network and watersheds for each drainage segment for 
Somalia country. 
 
 
 
Figure 18 Drainage network and watersheds for each drainage segment for 
Kenya country. 
 
 
Figure 19 Drainage network and watersheds for each drainage segment for 
South Sudan country. 
Finally, a comparison between ArcGIS Hydro Tools and 
TerraHidro regarding drainage network quality is presented 
in the Figure 20. In the top figure, the ArcGIS Hydro Tools 
results appear in blue lines and the TerraHidro ones are in 
red lines. The results obtained by ArcGIS in the flat areas 
indicates that the method D8 is used directly in these areas 
without prior corrections. The parallel lines generated by 
ArcGIS indicate incorrect representation of the drainage 
within the flat areas. TerraHidro, for the same areas, identify 
automatically each flat areas creating a path through the 
middle of the flat area, following its longitudinal direction. 
All path into flat area arrives at this longitudinal path in a 
physical way. 
This comparison aims to show that TerraHidro have a 
method to determine the path in the flat areas generating 
coherent drainage networks. Parallel lines that appear in 
ArcGIS Hydro Tools drainage networks are caused by the 
method used in ArcGIS that converts pits in flat areas and, 
after that, uses D8 method in these flat areas. The method 
used by TerraHidro system does not produce these errors 
166
Copyright (c) IARIA, 2013.     ISBN:  978-1-61208-251-6
GEOProcessing 2013 : The Fifth International Conference on Advanced Geographic Information Systems, Applications, and Services

because a path between from a pit is found without the need 
to create flat areas. 
 
 
 
Figure 20 Comparison of quality of drainage network extraction between 
TerraHidro  and ArcGIS Hydro Tools. 
V. 
CONCLUSION 
The concept of the TerraHidro distributed hydrology 
modeling system and its current development stage were 
described here. The PFS method to extract drainage network 
was shown together with improvements to define drainage 
into the flat areas such as large rivers and lakes. In addition, 
the 8-neighbor mean to eliminate pits without creating others 
in its neighborhood was presented. 
Several results were presented here. All of them used 
large regions to show the quality of the extracted drainage 
and to test the robustness of TerraHidro. Drainage 
extractions were executed using a PC computer with 2 GB of 
RAM memory. 
A comparison of the drainage extracted by TerraHidro 
and ArcGIS Hydro Tools was made for Purus Amazon sub 
basin. The comparison showed that TerraHidro produces 
more realistic drainage than ArcGIS Hydro Tools do. 
All processing used SRTM 90 meters data set. Other data 
sets such as ASTER-GDEM will be used in the future. 
ACKNOWLEDGMENT 
This article is part of Automatic Protection Delineation 
Brazilian Areas project entirely supported by the Fundação 
de Amparo à Pesquisa do Estado de São Paulo - FAPESP a 
Brazilian government Agency that finances studies and 
projects in the area of science and technology. 
REFERENCES 
 
[1] C. D. Rennó, “Construção de um Sistema de Análise e 
Simulação Hidrológica: Aplicação a Bacias Hidrográficas (in 
portughese),” Ph.D. thesis, National Institute for Space 
Research, São José dos Campos, 2003. 
[2] J. F. O’Callaghan and D. M. Mark, “The Extraction of 
Drainage Networks from Digital Elevation Data,” Computer 
Vision, Graphics, and Image Processing, 28:323–344, 1984. 
[3] P. A. Burrough and R. A. “McDonnell, Principles of 
Geographical Information Systems.” Oxford University Press, 
New York, 1998. 
[4] L. 
P. 
Chew, 
“Constrained 
Delaunay 
triangulations,” 
Algorithmica 4(1):98-108, 1989. 
[5] W. R. Dawes and D. L, Short, “TOPOG Series Topographic 
Analysis and Catchment Drainage Modelling Package: User 
Manual,” Canberra, CSICO, 1988. 
[6] J. Fairfield and P. Leymarie, “Drainage Networks from Grid 
Digital Elevation Models” Water Resource Research, 
30(6):1681–1692, 1962. 
[7] J. Garbrecht, F. L. Ogden, P. A. DeBarry and D. R. 
Maidment, “GIS and Distributed Watershed Models. I:Data 
Coverages and Sources,” Journal of Hydrologic Engineering, 
6(6):506-514, 2001. 
[8] S. Rosim, “Estrutura baseada em grafos para representação 
unificada de fluxos locais para modelagem hidrológica 
distribuída. 2008. 110 p. (INPE-15320-TDI/1363). (PhD 
thesis in applied computation) - Instituto Nacional de 
Pesquisas Espaciais, São José dos Campos, 2008. 
[9] S. Rosim, A. M. V. Monteiro, C. D. Rennó, J. R. F Oliveira,  
“Terrahydro - A distributed hydrological system using graph 
structure for unified water flow representation,” Proc. of IEEE 
Geoscience and Remote Sensing Symposium (IGARSS), 
Vancouver, 2011. 
[10] E. S. Abreu, S. Rosim, C. D. Rennó, J. R. F. Oliveira, A. C. 
Jardim, J. O. Ortiz, L. V. Dutra, “Terrahidro a distributed 
hydrological system to delimit large basins,” Proc. of IEEE 
Geoscience and Remote Sensing Symposium (IGARSS), 
Munich, 2012. v. 1, pp. 300-301. 
[11] S. Rosim, A. M. V. Monteiro, C. D. Rennó, J. R. F. Oliveira, 
“Uma ferramenta open source que unifica representações de 
fluxo local para apoio à gestão de recursos hídricos no 
Brasil,” Informática Pública, v. n. 1, p. 29-49, 2008. 
[12] A R. Jones, “Algorithms for using a DEM for mapping 
catchment areas of stream sediment samples”, Computers & 
Geosciences 28 (2002) 1051–1060. 
[13] B W. Collischonn, D. C. Buarque, A. R. da Paz, C. A. 
Bulhões Mendes, and F. M. Fan, “Impact of Pit Removal 
Methods on DEM Derived Drainage Lines in Flat Regions”, 
AWRA 2010 Spring Speciality Conference Orlando, FL. 
[14] R. Jana, T. V. Reshmidevi, P. S. Arun, T. I. Eldho, “An 
enhanced technique in construction of the discrete drainage 
network from low resolution spatial database,” Cumputers & 
Geosciences archive, v. 33, I. 6, June 2007, Pergamon Press, 
Inc. Tarrytown, NY, pp. 717-727, 2007. 
 
167
Copyright (c) IARIA, 2013.     ISBN:  978-1-61208-251-6
GEOProcessing 2013 : The Fifth International Conference on Advanced Geographic Information Systems, Applications, and Services

