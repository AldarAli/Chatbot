Method for Parameter Adjustment for Automated Visual Inspection of Botteled
Liquids
Irina Topalova
Faculty of German Engineering Education and Industrial Management
Technical University Sofia
Sofia, Bulgaria
e-mail: itopalova@abv.bg
Abstract — A method for parameter adjustment for automated
visual control of bottled liquids is presented, aiming at
reducing the execution time of bottling when liquid colors are
similar and not easily visible. Edge profile detection is applied
to find the transition points where a line fitting algorithm
connects them in a line. The obtained short execution time and
very good accuracy enable inspection of bottles in a moving
condition. The proposed algorithm is tested with blurred
images of beer and mineral water bottles, according to real
production conditions. The represented method could be
applied in any related cases in which the liquid level is not
easily visible and the execution time is a crucial component.
Keywords - visual inspection; image processing; line fitting;
execution time.
I.
INTRODUCTION
There are many automated systems for automated visual
inspection of the liquid level in the bottling industry
[1][2][3][4][5]. The specifics of this production demand
liquid level control in the moving condition of the conveyer
belt. In the case of sparkle liquids and beer bottled
production, one problem is fixing the fill level of foamed
surfaces in moving condition, all within a short execution
time, even when the bottle and liquid colors are very similar.
Thus, the optimization of the decisive algorithm parameters
in terms of quick-operation and high accuracy is imperative.
In addition, the problem has to be solved with a simple and
inexpensive technology equipment, aiming at reducing the
production costs.
In this research, a method is proposed for liquid level
inspection in moving condition, when the bottle and liquid
colors are very similar and the transition between them is not
easily visible. Edge profile detection is applied to find the
transition points where a line fitting algorithm connects them
in a line. The algorithm’s parameters are adjusted to
minimize execution time, based on the analysis of the
influence of the significant image parameters over the
execution time. The benefits of the obtained short execution
time and very good accuracy enable inspection of bottles in
moving condition, thus, eliminating the need of additional
technological appliances applying a single smart camera.
The experiments are implemented using a Smart Camera
NI 1742. Triggered infrared lighting is used to eliminate the
variations in environmental lighting. To simulate the blur
noise added to the images because of the conveyer belt
movement, the calculated blur for typical conveyer belt
velocities in number of pixels is added to each image.
Further tests with cameras having different image resolution,
by different light intensities, are foreseen.
Section I-A describes the state-of-the-art. In Section II,
the overall proposed method for liquid level detection is
defined. Section III-A describes the image parameters that
influence the execution time/accuracy. Line fitting algorithm
is represented in Section III-B. In Section IV, the developed
algorithm for parameter adjustment is explained, after the
analysis of the execution time. The experiments and the
obtained results for images, resembling the moving conveyer
belt conditions for many examples are represented and
discussed in Section V.
A.
State-of-the-Art
Machine vision is implemented nowadays in the modern
automated production systems for real-time control of
different product parameters [1][3][6]. In automated bottle
filling production, most of the checks are concentrated on the
presence/absence, position or quality of different bottle parts,
such as cap, label or defects. Liquid fill level control is
relatively rarely accomplished, especially when the bottle
and liquid colors are very similar. For example, the Q Check
verification system [4] inspects flat and sipper caps on
beverage bottles for cap presence and height, dust cap
presence and fill level. Because the check is in moving
condition, the liquid surface is often falsly recognized and
the bottle is incorrectly automatically rejected. Mettler
Toledo system [5] demonstrates a Full Bottle Inspection
system (FBI) with simple part setup, very intuitive train tools
with training in less than one minute, rejection off the line of
all defective bottles. It checks the liquid level in movement,
but without discussion and recommendations about achieved
accuracy when fixing the fill level of foamed surfaces.
DATALOGIC [6] is a system using a complex multiple
cameras/mirrors structure for cap and label detection and
defective rejection. It represents no fill level control, thereby
the rest of the bottle components are checked with fixed
parameter values with no discussion about the execution
time. In some systems [2], this control is completed in a stop
conveyor belt condition, adding to the production line a
technological appliance. In this case, the technological cycle
time increases together with raising the cost of the system.
15
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-405-3
ICAS 2015 : The Eleventh International Conference on Autonomic and Autonomous Systems

In conclusion, we did not succeed to find in the existing
similar systems any analysis of the influence of the
significant image parameters over the execution time for
foamed
liquid
level
determination,
while
maintaining
accuracy. As result of the implemented time analysis, a
method for parameter adjustment is proposed. The proposed
method is verified with many blurred images, aiming to
simulate the real production conditions. The experiments are
implemented using only simple machine vision components
with no need of adding to the production line some special
technological
appliances.
The
main
advantage
of
the
presented approach is the non-intuitive, but based on the
image parameter analysis method for training the vision
system for fast real-time execution. It could be applied in any
related case where the liquid level is not easily visible and
the execution time is a crucial component.
II.
METHOD FOR LIQUID LEVEL LINE DETECTION
The proposed method is based on analyzing the edge
strength profiles along different parallel, preliminary fixed
lines in a search direction. The algorithm finds the first pixel
along each edge strength profile having more than a
minimum chosen difference between the intensity values of
the edge and the surrounding pixels. The method of least
squares is used to determine the best fit line to the data set,
formed by detected pixels along all lines. The influence of
four parameters – edge strength, kernel size, projection
width and interline gap over the execution time and level
line
accuracy
are
analyzed
and
a
method
for
their
adjustment is proposed. The method and its algorithm are
tested on 30 samples of brown bottles of beer and 30
samples of white bottles of mineral water. Infrared triggered
lighting is used for image acquisition of moving bottles.
III.
DEFINITION OF PARAMETERS AND LINE FITTING
ALGORITHM
Four parameters – edge strength, kernel size, projection
width and interline gap have the strongest influence over the
execution time and accuracy when determining the liquid
level line. They are used to detect the liquid level edge
points.
A. Definition of Used Parameters
Edge strength – This is the edge contrast. It determines
the variation in the grayscale values between the background
and the edge. Figure 1 shows the Grayscale profile in a
search direction. The edge strength can vary for the changes
in lighting conditions. That is reason to use infrared
triggered lighting on the acquisition moment to eliminate
these changes. The edge length characterizes the slope of
the edge. Edges with gradual transitions between the
background and the edge have a longer edge length.
Kernel size - A kernel is usually a 3x3, 5x5, 7x7, etc.
structure that represents a pixel and its relationship to the
pixel neighbors [7]. The chosen size of the kernel should be
based on the expected sharpness, or slope of the searched
edge.
Search Direction
Gray Level
Intensities
Edge Strength
Edge Length
Figure 1. Greyscale profile
Projection width – Determines the amount of pixels
perpendicular to the search direction [7], that are averaged at
each pixel along the search line to calculate the edge profile
strength. The projection width has to be increased when the
image is noisy or blured because of the movements of the
aquisiting object.
Interline gap – Defines the distance between two
neighboring search lines in pixels.
B. Line Fitting
The algorithm finds the first pixel along each edge
strength profile having
less
than
a minimum chosen
difference/threshold between the intensity values of the edge
and the surrounding pixels. All such pixels are considered to
be Liquid Level Pixels (LLP) or border pixels. The method
of least squares is used to determine the best fit line to the
LLPs data set, formed by the detected pixels along all lines.
When n LLPs with coordinates [xi, yi] are found, the
approximating straight line will have the equation
0
1
( )
Y
f x
X
α
α
=
=
+
.
(1)
Then,
0
α and
1
α values are searched, so that a minimum
Mean Square Distance (MSD), according to Figure 2, will be
obtained.
0
1
2
1
min
,
n
MSD
di
α α i
=
∑
=
(2)
di
Figure 2. Line fitting
Foreseeing the expressions
1
1
i
n
x
x
n i
=
∑
=
;
1
1
i
n
y
y
n i
=
∑
=
and
16
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-405-3
ICAS 2015 : The Eleventh International Conference on Autonomic and Autonomous Systems

(
)
2
2
2
2
2
1
1
1
1
1
.
i
n
n
n
n
x
x
x
n x
x
x
i
i
i
n
i
i
i
i












−
=
−
=
−
∑
∑
∑
∑






=
=
=
=






(3)
the coefficients
1
α and
α0
get the values of
( )
1
2
2
1
1
. .
.
i i
i
n
x y
n x y
i
n
x
n x
i
α


−


 ∑

 =

= 

−


 ∑

 =

(4)
.
0
1
y
x
α
α
=
−
(5)
The line with the best quality is the line that shows the
lowest MSD [8]. The quality of the line is further improved
by successively removing the furthest pixels from the current
line until a preliminary minimum score is obtained.
The result of the line fitting algorithm is a line that is fit
to the best set of the LLPs after ignoring the outlying pixels.
IV.
PARAMETER ADJUSTMENT
The inspection of the liquid level in motion condition
sets requirements of short execution times. The phase of
detection of the liquid level, together with the phase of
image acquisition, are the most time consuming steps in the
algorithm.
A.
Execution Time Analysis
As the parameter values are decisive for accuracy of
liquid line determination, it is important to analyze the
influence of the four above mentioned parameters over the
execution
time.
On
the
base
of
analyses,
optimum
proportion parameter values and execution time have to be
found. The two graphics in Figures 3 and 4 show that the
execution time needed for liquid level detection, including
edge detection and line fitting, increases linear with
increasing the kernel size and the projection width values.
However, the increase in the projection width essentially
influences the execution time.
Figure 3. Influence of the Kernel size variations over the Execution time
Figure 4. Influence of the Projection width variations over the Execution
time
Figure 5. Influence of the Interline gap variations over the Execution time
Figure 5 shows that the increase in the interline gap reduces
more rapidly the execution time.
B.
Proposed Method for Parameter Adjustment
Taking into account that the bottles are inspected in
moving condition, obviously some froth is generated,
especially in the case of beer production. That means that
the intensity along the edge line changes gradually and
finding the liquid level edge points requires an increase in
the kernel size. Also, it is well known [8] that if the image is
noisy, an increase in the projection width is necessary. So,
considering
these
circumstances
and
aiming
at
high
accuracy, it is reasonable to begin searching the edge
profiles with high values of kernel size and projection width
and low interline gap value. To reduce the execution time,
the following parameter adjustment method is proposed:
1.
Choose high values of kernel size and projection
width, choose low values of interline gap to obtain
right edge points and right line fitting.
Straight edge minimum threshold is chosen based
on empirical approach.
2.
Reduce the kernel size till line fitting is still correct.
3.
Reduce the projection width till line fitting is still
correct. Stop reducing when line fitting errors
appear.
4.
Increase interline gap till line fitting is still straight.
5.
If no straight edges are found, reduce the straight
edge minimum threshold until the step finds a
straight edge again.
17
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-405-3
ICAS 2015 : The Eleventh International Conference on Autonomic and Autonomous Systems

V.
EXPERIMENTS AND RESULTS
The experiments are implemented using a Smart Camera
NI 1742 with triggered infrared lighting and software Vision
Builder AI 2011. To simulate the blur noise [9] added to the
images because of the conveyer belt moving, the calculated
blur in number of pixels is added to each image. For a typical
conveyer belt velocity of 25m/min
417 mm/sec and image
resolution of 300 dpi
118,11 dp(cm)
11,81 dp(mm), the
calculated conveyer belt velocity measured in Pixel per
second is Vp = 417x11,8 = 4920 Pix/sec. Then, the resulting
Motion Blur = Vp * Exposure time = 4920 x 1/125
40 Pix
Motion Blur. In our case, a short value of Exposure time =
1/500 is chosen which corresponds to 9 Pix Motion Blur.
This value is added to the test images to simulate the motion
of the bottles [10][11]. Figures 6, 7 and 8 represent the
subsequent steps for parameter adjustment and show the
change in Edge Strength Profile moving through the steps of
the proposed algorithm for parameter adjustment. Finally,
the obtained parameter values with line fitting still correct for
all of the 60 exemplars are found as: edge strenght 5, kernel
size 5, projection width 5 and interline gap 21 pixels.
Execution time for 60 exemplars is 60.424 msec.
Figure 8 shows the final line fitting with a distinct Edge
Strength
Profile
and
an
appropriate
Minimum
Edge
Strength/threshold (MES). Figure 10 represents the finally
obtained line fitting for some of the tested bottled mineral
water samples. Table I. represents the execution time and
accuracy for 20, 40 and 60 bottles when moving through the
steps of the proposed algorithm.
The accuracy is calculated as [(number of all exemplars -
number of exemplars with bad line fitting)/ number of all
exemplars].100 [%]. Figure 9 shows the influence of the
parameter value reduction over the execution time and over
the accuracy according to the data in Table I. The first rising
line in the graphic represents cases 1, 2, 3, the second rising
(a)
(b)
Figure 6. Edge Strength Profile for search line 8: (a) edge strenght 7, kernel
size 23, projection width 23 and interline gap 9 pixels; (b) edge strenght 7,
kernel size 9, projection width 23 and interline gap 9 pixels
(a)
(b)
Figure 7. Edge Strength Profile for search line 8: (a) edge strenght 7, kernel
size 9, projection width 9 and interline gap 9 pixels; (b) edge strenght 7,
kernel size 5, projection width 5 and interline gap 9 pixels
Figure 8. Edge Strength Profile for search line 8: edge strenght 5, kernel size
5, projection width 5 and interline gap 21 pixel
line represents cases 4, 5, 6, etc. It is visible that the
reduction of parameter projection width influences stronger
the reduction of execution time (rising lines 3,4, cases 7 to
12) then reduction of kernel size (cases 4, 5, 6). The
strongest is the influence of inceasing the interline gap (cases
16, 17, 18).
Figure 9. Execution time and accuracy for 20, 40 and 60 tested exemplars
according to the cases 1 to 18 in Table I.
18
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-405-3
ICAS 2015 : The Eleventh International Conference on Autonomic and Autonomous Systems

Figure 10. Line fitting for bottled mineral water - edge strenght 32, kernel
size 9, projection width 9 and interline gap 77 pixels
TABLE I. EXECUTION TIME AND ACCURACY
Line fitting parameters
Case
Test Samples
Time[ms]
Accuracy[%]
1
20 bottles
97.642
100.00
2
40 bottles
196.462
100.00
3
60 bottles
297.709
100.00
4
20 bottles
84.176
100.00
5
40 bottles
168.692
100.00
6
60 bottles
250.847
100.00
7
20 bottles
46.216
100.00
8
40 bottles
90.418
97.50
9
60 bottles
137.102
96.00
10
20 bottles
32.941
95.00
11
40 bottles
64.988
97.50
12
60 bottles
96.494
95.00
13
20 bottles
24.434
95.00
14
40 bottles
48.811
92.50
15
60 bottles
72.461
93.30
16
20 bottles
20.431
85.00
17
40 bottles
41.047
87.50
18
60 bottles
60.424
88.30
MES=5;
Gap = 21
Kernel Size = 5;
Projection Width = 5
MES=7;
Gap = 9
Kernel Size = 23;
Projection Width = 23
MES=7;
Gap = 9
Kernel Size = 9;
Projection Width = 23
MES=7;
Gap = 9
Kernel Size = 9;
Projection Width = 9
MES=7;
Gap = 9
Kernel Size = 5;
Projection Width = 5
MES=7;
Gap = 15
Kernel Size = 5;
Projection Width = 5
The optimum execution time reduction is obtained and the
parameter value adjustment stops when accuracy falls
between 88.5% and 88.3%, because further parameter
adjustments will reduce the obtained accuracy.
VI.
CONCLUSION
The obtained results show that the proposed method for
liquid level inspection with parameter adjustment is suitable
even when the bottle and liquid colors are very similar and
the transition between them is not properly visible. It was
tested with blurred images to simulate the conveyer belt
movement
in
real
production.
The
experiments
are
implemented using only simple machine vision components
with no need of adding to the production line some special
technological
appliances.
The
main
advantage
of
the
represented approach is non-intuitive, but based on the image
parameter analysis method for training the vision system for
fast real-time execution. The represented method could be
applied in any related task where the execution time is a
crucial component. In order to generalize this method,
further tests with cameras having different image resolution,
by different light intensities, are possible. Although having in
mind that the most up-to-date automated visual systems use
triggered infrared lighting, we expect these variations will
not impact significantly the proposed methodology.
REFERENCES
[1]
http://www.fdbusiness.com/2013/11/inspection-system-
improves-productivity-in-beer-industry/,
retrieved:
April,
2015.
[2]
https://www.youtube.com/watch?v=_7pkjlEmzqI,
Visual
system
developed by National Instruments, retrieved: April, 2015.
[3]
http://globalinspectiontek.com/_3ce8bb4d.html,
retrieved:
April, 2015.
[4]
https://www.youtube.com/watch?v=ZG9GIQgmisY,
retrieved: May, 2015.
[5]
https://www.youtube.com/watch?v=BPyrfivjbSE,
Metter
Toledo System, retrieved: May, 2015.
[6]
https://www.youtube.com/watch?v=ffkdAPKeuIU,
DATALOGIC Visual System, retrieved: May, 2015.
[7]
W. K. Pratt, “Introduction to Digital Image Processing”, CRC
Press, ISBN 9781482216691, September 13, 2013.
[8]
S. J. Ahn, “Geometric Fitting of Parametric Curves and
Surfaces”, Journal
of
Information
Processing
Systems 4,
December, 2008, pp. 153-158.
[9]
B. G. Batchelor, Machine Vision Handbook, Springer, ISBN
9781849961684, 2012.
[10] National Instruments, NI Vision Builder for Automated
Inspection User Manual, 373379C-0. National Instruments,
2006.
[11] National Instruments, NI Vision Builder Assistant, 2011.
19
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-405-3
ICAS 2015 : The Eleventh International Conference on Autonomic and Autonomous Systems

