Smart Sensor Magnetometer Based Virtual Gyroscope
Baptiste Delporte, Laurent Perroton, Thierry Grandpierre
Universit´e Paris Est, ESIEE Engineering,
Marne-la-vall´ee, France
Email: {delportb,perrotol,grandpit}@esiee.fr
Jacques Trichet
Freescale Semiconductor, Inc.
Toulouse, France
Email: jacques.trichet@freescale.com
Abstract—In this paper, we propose two methods based
on quaternions for computing the angles of inclination and
the angular velocity with 6 degrees of freedom using the
measurements of a 3-axis accelerometer and a 3-axis magne-
tometer. Each method has singularities which occur during
the computation of the orientation of the device in the 3-
dimensional space. We propose solutions to avoid these singu-
larities. Experimental results are given to compare our model
with a real gyroscope.
Keywords-smart sensor; sensor fusion; accelerometer; mag-
netometer; angular velocity; gyroscope
I. INTRODUCTION
The computation of the angles of inclination of a device
and its angular velocity has many applications for aeronau-
tics, transportation systems, human motion tracking, games
and virtual reality. Classical methods use accelerometers,
magnetometers and gyroscopes. For some particular angles,
there are singularities for which it is impossible to compute
neither the orientation of the device in the 3-dimensional
space nor its angular velocity [1, page 407].
Our goal is to design a smart sensor magnetometer based
virtual gyroscope, i.e. a method for computing the angular
velocity based on the measurements of a 3-axis accelero-
meter and a 3-axis magnetometer, without any gyroscope,
and with 6 degrees of freedom: 3 degrees of freedom are
provided by the accelerometer and the others are provided by
the magnetometer. It is easier to implement, less expensive
and has a lower power consumption than the classical
gyroscope solutions. Our target is small motion tracking
with embedded devices like cellular phones, with application
ﬁelds like virtual or augmented reality. Moreover, it is
possible to create a virtual gyroscope using a magnetometer
and an accelerometer, whereas it is not possible to create
a virtual magnetometer nor a virtual accelerometer using
a gyroscope only. Methods with accelerometers only have
been already proposed in [2], [3], [4], [5].
A well-known method for computing a strapdown gyro-
scope output simply consists in differentiating the angles
of inclination of the device, but we want to compute the
total angular velocity, which is the addition of the angular
velocities about the three axes of the ﬁxed frame.
Two methods with two different approaches have been
developed. They are proposed in this paper. The method
that uses the angles of inclination of the device have been
implemented. The method that uses the rotation matrix will
be implemented and the two methods will be compared in
order to ﬁnd the method which offers the best precision on
the target architecture. This work is a collaboration project
between Freescale and ESIEE Engineering school which
started in June 2010.
In Section II, we introduce the platform and the sensors.
In Section III, a ﬁrst method for computing the angular
velocity using the absolute angles of inclination is presented.
In Section IV, a second method for computing the angular
velocity using the rotation matrix is presented. In Section
V, experimental results are given.
II. HARDWARE AND SMART SENSORS
We use the new Freescale MMA9550L smart sensor. This
motion sensing platform can manage multiple sensor inputs.
It includes a 3-axis accelerometer and a ColdFire V1 32-
bit microprocessor with an integrated Multiply and AC-
cumulate module (MAC module) for DSP-like operations.
An additional Honeywell HMC5843 3-axis magnetometer is
mounted on the MMA9550L board so that the two sensors
are strictly parallel and their frames are aligned.
This paper focuses on the mathematical model which
provides the angular velocity and the angles of inclination
of the device in the 3-dimensional space. The algorithms
have been implemented in the form of MATLAB scripts
for testing purposes and the curves show the results of
these implementations. In the future, the algorithms will be
directly implemented on the MMA9550L, since it includes
its own microprocessor.
III. VIRTUAL GYROSCOPE BASED ON THE ANGLES OF
INCLINATION OF THE DEVICE
In this section, the angles of inclination and the angu-
lar velocity are computed from the accelerometer and the
magnetometer measurements using Tait-Bryan angles and
quaternions.
A. Parametrization of Rotations with Tait-Bryan Angles
In order to describe the orientation of the device in the
3-dimensional space, 2 right-handed Cartesian coordinate
systems are used: a ﬁxed reference frame with Xr = North,
165
SENSORDEVICES 2011 : The Second International Conference on Sensor Device Technologies and Applications
Copyright (c) IARIA, 2011.     ISBN: 978-1-61208-145-8

Yr = East and Zr = Down (NED convention), and denoted
by the subscript r, and a moving frame attached to a mobile
device, denoted by the subscript d. The reference frame
and the device frame are aligned when the device is ﬂat
and aligned with the Xd axis pointed to magnetic North.
Rotation angles are positive when clockwise viewed along
the relevant axis vector in the positive direction.
The orientation of the device in the reference frame can
be described by Tait-Bryan angles: φ, θ and ψ. ψ is the
angle of rotation about the Zr axis (yaw). θ is the angle of
rotation about the Yr axis (pitch). φ is the angle of rotation
about the Xr axis (roll). Any rotation of the device can be
expressed as a composition of these three rotations in the
reference frame, as shown in Fig. 1.
O
Xr
Yr
Zr
ψ(1)
O
Xr
Yr
Zr
θ(2)
O
Xr
Yr
Zr
φ(3)
⃗v
Figure 1.
Angles φ, θ, ψ, and Composition of the 3 Rotations about Zr,
Yr and Xr Axes
A rotation about the Zr axis, the Yr axis or the Xr axis
can be respectively described by a rotation matrix Rz(ψ),
Ry(θ) or Rx(φ):
Rz(ψ)=
2
664
cos(ψ)
sin(ψ)
0
− sin(ψ)
cos(ψ)
0
0
0
1
3
775
Ry(θ)=
2
664
cos(θ)
0
− sin(θ)
0
1
0
sin(θ)
0
cos(θ)
3
775
Rx(φ)=
2
664
1
0
0
0
cos(φ)
sin(φ)
0
− sin(φ)
cos(φ)
3
775
The composition of the 3 rotations about the Zr axis,
then the Yr axis and ﬁnally the Xr axis, is described by the
rotation matrix R(φ, θ, ψ) = Rx(φ) · Ry(θ) · Rz(ψ).
It is possible to compute φ, θ, ψ and the angular ve-
locity ⃗ωr from the Earth’s magnetic ﬁeld
⃗Bd, expressed
in the device frame, and the Earth’s gravitational ﬁeld
⃗gd, expressed in the device frame. The magnetic ﬁeld is
measured by the magnetometer. On the other hand, the
accelerometer measures the total acceleration including the
gravitational ﬁeld, the acceleration provided by the user and
the acceleration due to the Coriolis force. Consequently, an
extraction of the gravitational ﬁeld ⃗gd needs to be performed
with a ﬁlter.
The expression of the Earth’s magnetic ﬁeld in the refer-
ence frame is given by ⃗Br =

2) Sliding Median Filter: A sliding median ﬁlter is used
in order to eliminate the highest frequencies sensor spurious
noise, which creates variations of the norm of ⃗gd. Since this
norm should be constant, we need to eliminate the samples
that have an erroneous norm. As we will see in section III-C,
⃗gd directly impacts the accuray of the entire computation
process, hence the need to get ⃗gd with the least error. The
sliding median ﬁlter uses a sliding window of n norms. At
the beginning, the window contains the ﬁrst n norms of the
ﬁrst n samples. Then, the norms of the window are sorted.
Finally, the median value of the window is extracted, and
the sample whose norm is the median value is output from
the ﬁlter, as shown in Fig. 4.
Let ⃗g
=
(gx gy gz)T
be the input vector,
⃗gf
=
(gfx gfy gfz)T the ﬁltered vector and i the index of the
sample. The expression of the ﬁlter is given by:
⃗gf(i) = ⃗g(k) such that ∥⃗g(k)∥ = median(∥⃗g(i−n+1..i)∥)
Then, the window slides to the right and the norms of
⃗g(i − n + 2..i + 1) are extracted. A sliding median ﬁlter
creates a delay of n − 1 samples.
i = 1
2
3
4
5
6
...
2.1
Extraction of a window of norms
Sorting of norms
i = 1
2
3
4
5
6
...
Median norm extraction
Norms ∥⃗g(i)∥
Extracted Norms ∥ ⃗gf(i)∥
2.2
⃗g(1) ⃗g(2)⃗g(3)⃗g(4)⃗g(5)
Measurements ⃗g(i)
Filtered Measurements ⃗gf(i)
⃗g(2)
2.2 2.6 1.5 2.3
1.5 2.1 2.2 2.3 2.6
+
Figure 4.
Sliding Median Filter
The gravitational ﬁeld ﬁltered with the sliding median
ﬁlter still has variations, a sliding average ﬁlter is used to
smooth it.
3) Sliding Average Filter: The sliding average ﬁlter uses a
sliding window of n samples. At the beginning, the window
contains the ﬁrst n samples. Then, the average value of the
window is extracted and output from the ﬁlter.
Let ⃗g =

gdNx
gdNy
BdNx
BdNy
φ
θ
ψ
1
0
sin(δ)
cos(δ)
−π/2
−π/2
0
0
−π/2
−π/2
π/2
−π/2
π
π
−π/2
π/2
1
0
sin(δ)
− cos(δ)
−π/2
−π/2
π
0
−π/2
π/2
π/2
−π/2
0
π
−π/2
−π/2
0
−1
cos(δ)
− sin(δ)
−π/2
0
0
π/2
π
π
0
−1
− cos(δ)
− sin(δ)
−π/2
0
π
π/2
π
0
−1
0
− sin(δ)
− cos(δ)
−π/2
π/2
0
0
π/2
π/2
π/2
π/2
π
π
π/2
−π/2
−1
0
− sin(δ)
cos(δ)
−π/2
π/2
π
0
π/2
−π/2
π/2
π/2
0
π
π/2
π/2
0
1
− cos(δ)
sin(δ)
−π/2
π
0
π/2
0
π
0
1
cos(δ)
sin(δ)
−π/2
π
π
π/2
0
0
Table I
TABLE OF SINGULARITIES
In Eq. 5, i, j and k are imaginary numbers: i2 = j2 =
k2 = −1, and i · j = −j · i = k, j · k = −k · j = i,
k · i = −i · k = j. Therefore, it is possible to compute
the product of two quaternions q =

Computation
of φ, θ, ψ
+
Singularity
⃗ad
⃗Bd
⃗gd
Quaternion
q
Angular
⃗ωr
⃗ωr
δ
Velocity
φ, θ, ψ
q
of The
M
Detection
Computation
Matrix M
Rotation
Extraction
of ⃗gd
Figure 5.
Computation Process 2
A. Computation of the Rotation Matrix M
Let ⃗v =

Figure 6.
Extraction of ⃗gd
B. Angular Velocity
Experimental results of the angular velocity computed
with our ﬁrst method virtual gyroscope (top) compared to
the one from a real gyroscope (bottom) are given in Fig.
7. The real gyroscope is tied to the accelerometer and the
magnetometer and their frames are aligned to get a 9 degree
of freedom system. The similarity of the two measures
conﬁrms the accuracy of our model.
Figure 7.
Angular Velocity Computed With our Virtual Gyroscope (top)
vs. a Real one (bottom)
VI. CONCLUSION AND FUTURE WORKS
In this paper, we have presented two methods to imple-
ment a virtual gyroscope that only uses the measurements
of an accelerometer and a magnetometer, with 6 degrees of
freedom.
The two methods have their own advantages and draw-
backs. The method which uses the angles of inclination is
easier to implement, but there are 8 singularities, which
need to be solved. Moreover, the computation of ψ depends
on the computation of θ, which in turns depends on φ. If
there is a singularity on φ, the computation of the angles
is not possible. On the other hand, the method with the
rotation matrix has only two singularities but its computation
cost is higher. The second method has not been completely
implemented and validated yet; this is our current work.
The precision of both methods and their limitations must
be investigated and will be our main future work.
Finally, we plan to optimize the implementation of both
methods on the MMA9550L. This will allow us to provide
the angular velocity and the angles of inclination of the
device and use them for several applications, like a 3-
dimensional mouse, a virtual joystick, a human motion
tracker. The MMA9550L board can communicate with the
PC with a Bluetooth connection. Consequently, the board
can become a portable device with its own power supply.
ACKNOWLEDGMENT
The authors would like to thank Freescale for their sup-
port, the platform, and Mr. Mark Pedley whose work is the
base of this project.
REFERENCES
[1] J. R. Wertz, Spacecraft Attitude Determination and Control,
J. R. Wertz, Ed.
D. Reidel Publishing Company, Dordrecht,
Holland, 1978.
[2] T. Liu, G.-R. Zhao, and S. Pan, “New calculating method of
angular velocity in gyroscope-free strapdown inertial naviga-
tion systems,” Systems Engineering and Electronics, vol. 32,
no. 1, pp. 162–165, January 2010.
[3] P. Schopp, L. Klingbeil, C. Peters, A. Buhmann, and Y. Manoli,
“Sensor fusion algorithm and calibration for a gyroscope-free
imu,” in Proceedings of the Eurosensors 23rd Conference,
vol. 1, no. 1, 2009, pp. 1323–1326.
[4] C. Wang, J.-X. Dong, S.-H. Y., and X.-W. Kong, “Hybrid
algorithm for angular velocity calculation in a gyroscope-
free strapdown inertial navigation system,” Journal of Chinese
Inertial Technology, vol. 18, no. 4, pp. 401–404, 2010.
[5] X.-N. Wang, S.-Z. Wang, and H.-B. Zhu, “Study on models of
gyroscope-free strap-down inertial navigation system,” Bing-
gong Xuebao/Acta Armamentarii, vol. 27, no. 2, pp. 288–292,
2006.
[6] D.
Stahlke.
(2007)
Quaternions
in
classical
mechanics.
[Online]. Available: http://www.stahlke.org/dan/phys-papers/
quaternion-paper.pdf
[7] A. L. Schwab. (2002) Quaternions, ﬁnite rotation and Euler
parameters. [Online]. Available: http://audiophile.tam.cornell.
edu/∼als93/Publications/quaternion.pdf
[8] J.
Diebel,
“Representing
attitude:
Euler
angles,
unit
quaternions,
and
rotation
vectors,”
Stanford
University,
California
94301-9010,
Tech.
Rep.,
october
2006.
[On-
line]. Available: http://www.astro.rug.nl/software/kapteyn-beta/
downloads/attitude.pdf
170
SENSORDEVICES 2011 : The Second International Conference on Sensor Device Technologies and Applications
Copyright (c) IARIA, 2011.     ISBN: 978-1-61208-145-8

