A Weather-forecasting Improved CFDP over Ka-band Channel 
Qiuping Zheng, Zhihua Yang, Jian Jiao, Qinyu Zhang 
Department of Electronics & Information Engineering, Harbin Institute of Technology Shenzhen Graduate School, Shenzhen, 
China 
zhengqiuping1987@126.com, yangzhihua@hitsz.edu.cn, hellojesus@sina.com, zqy@hitsz.edu.cn 
 
 
Abstract—A novel file delivery scheme over a Ka-band 
channel is proposed, which is heavily dependent on weather 
around the earth’s atmosphere. The proposed scheme based 
on CFDP is designed to resist the influence of weather 
conditions by the weather-forecasting.  In this work,  the  
condition-forecasting model that the weather sequence is 
forecasted through the first two states is constructed, 
demonstrated by the theoretical analysis and furthermore, 
implement 
of 
forecasting 
algorithm 
is 
also 
carefully 
researched and designed. Simulating results show that the file 
delivery time of selection-waiting CFDP with weather-
forecasting is reduced effectively compared with traditional 
CFDP.  
Keywords-Ka-band; 
weather-forecasting; 
CFDP; 
file 
delivery time;  NAK 
I. 
II. 
 INTRODUCTION  
As a result of long round trip times and frequent packet 
errors, the CFDP (CCSDS File Delivery Protocol) for 
deep-space communications was proposed by the CCSDS 
(Consultative Committee for Space Data Systems) [1][2]. 
On the one hand, deeper space exploration, further probing, 
and even larger amount of data transferred, not only lead to 
more and more CFDP retransmissions, but also increases of 
the file transfer delay; thus, the validity of the data 
transmission was seriously affected. On the other hand, as 
the Ka-band is strongly influenced by weather conditions, 
CFDP has no relevant functions to resist the state's high 
error rate of bad weather. Although Ka-band links can be 
available to a large range of bandwidth, which will greatly 
increase the capabilities and capacity of the future space 
networks, yet they are highly vulnerable to ﬂuctuations in 
weather, such as the rainfall. In this paper, the selection-
waiting CFDP in order to meet the change of Ka-band 
weather conditions is proposed due to the original CFDP 
was highly improved in that the file transfer delay was 
decreased efficiently.  
 Some works had been done in order to improve the 
performance of CFDP by researchers. In [3], an automatic 
repeat-request 
(ARQ) 
scheme 
of 
the 
Consultative 
Committee for Space Data Systems file-delivery protocol for 
the single-hop file-transfer operation was presented, and the 
CFDP performance was in detail analysed in [4-7], which 
came down to the cislunar, geo-stationary Earth orbit (GEO) 
and low Earth orbit (LEO) link environments.  
A novel file delivery mechanism over a Ka-band channel 
is proposed in this paper, which is heavily dependent on 
weather of the earth.  
This paper is organized in the following way. Firstly, the 
related works of our study are briefly explained, which 
contain deferred NAK CFDP transmission mechanism and 
Gilbert-Elliot channel. Secondly, the weather-forecasting 
algorithm is thoroughly demonstrated. Thirdly, the 
selection-waiting CFDP is designed and the simulation of 
the novel file delivery mechanism is illustrated and 
satisfied results are gained. 
PROBLEM FORMULATION 
The Deferred NAK CFDP Transmission Mechanism is 
produced in the background that TCP/IP uses less efficiently 
in space communication, but the CFDP is a transmission 
protocol for the application layer [3]. Then CCSDS 
proposed four different ways for NAK in CFDP; they are 
Immediate NAK, Prompted NAK, Asynchronous NAK and 
Deferred NAK. In this paper, we take Deferred NAK CFDP 
as an example of analysis simplicity. As is shown in Figure 
1, when file transmission states, the object file is divided 
into a set of protocol data units (PDUs) before being sent. At 
the first “spurt”, the sending entity of CFDP core procedure 
issues all PDUs of file in order. As soon as the EOF PDU is 
received correctly, the receiving entity acknowledges it with 
ACK (EOF) and then checks the integrality and validity of 
object file by file information contained in the Meta PDU. 
Those sequence numbers of missing PDUs are listed and 
reported back to sending entity by a NAK message. 
According to the information in NAK, sending entity 
initiates the second “spurt” consisted of the PDUs required 
by receiving entity, and so on. Once all of object file PDUs 
are received successfully, the receiving entity returns back a 
FIN PDU to the sending entity, which requires an 
acknowledgement with ACK (FIN). When ACK (FIN) is 
successfully delivered to the receiving entity, this 
transmission is finished and closed. 
 
Figure 1.  Two error state AWGN channel Gilbert-Elliot model 
 In the study of channel model, according to the Gilbert-
Elliot channel [8], a variation of the additive white 
Gaussian noise (AWGN) channel is used to model different 
bit error rate (BER) in each weather state. This type of 
73
Copyright (c) IARIA, 2012.     ISBN:  978-1-61208-194-6
SPACOMM 2012 : The Fourth International Conference on Advances in Satellite and Space Communications

channel, called the Gilbert-Elliot (GE) channel [8], has two 
weather states, a good and a bad weather state, which are 
separated by the threshold value. During good weather 
conditions, most of the transmitted packets will be received 
successfully, during bad weather conditions, however, most 
of the transmitted packets will generate some errors due to 
the high noise temperature at receiver. Therefore, two 
different BERs are applied to each good and bad weather 
state. In our new model, we define the relatively high BER 
value for the bad weather state and relatively low BER 
value for the good weather state.   
To capture the weather correlation, the Gilbert-Elliot 
channel with two weather states are shown in Figure 2. The 
transition from one state to another state is defined by the 
transition matrix P, which completely characterizes the 
channel behavior. In this model, the current state is 
determined by the previous state, and the 
G
  and
B
 are 
the transition probabilities from good to bad and from bad 
to good state, respectively. 
G
G
P B
)  
|
(
B
B
P G
)  
|
(
G
G
P G
| )  1  
(
B
B
P B
| ) 1 
(
 
1

 
1

 
Figure 2.   Gilbert-Elliot channel  
Then the transition matrix is  
(
/
)
(
/
)
(
/
)
(
/
)
1
1
G
G
B
B
P G
G
P B
G
P
P G
B
P B
B






 



 
 







                    (1)  
 
The difference of the file transfer delay between Gilbert-
Elliot (GE) channel and AWGN channel is illustrated in 
Figure 3, which depicts MRO (Mars Reconnassance Orbiter) 
sending files using the CFDP over Ka-band. Under the same 
condition (files are at most 10MB in size and transmission 
rate is 200kb/s) the simulation was carried out and the result 
was compared. Figure 3 shows that the file transfer delay 
over GE channel is longer than AWGN. It is said that the 
performance of CFDP is poor over Gilbert-Elliot channel. 
As a result, it is necessary to improve the CFDP over Ka-
band. 
10
-8
10
-7
10
-6
10
-5
300
310
320
330
340
350
360
370
380
Pe
Excepted File Delivery Time/s
AWGN vs. GE
 
 
AWGN
GE
 
Figure 3.   The file transfer delay over Gilbert-Elliot channel and AWGN 
channel 
III. 
WEATHER-FORECASTING ALGORITHM 
A. Condition-forecasting Model and Assumption 
It is known that the one-way packet transmission time is 

T  20 min
. Mars sends data packets to the earth, and 
then the earth returns the control commands to the Mars. 
The time spent in this process is  2T . We consider the bit-
error-rate of the receiver
eP  as threshold, when
10 5
eP


, 
we believe that the weather state is good. Otherwise, it is 
bad. 
,
,
e
e
P
P
good state
P
P
bad state






As is shown in Figure 4, assume that the initial channel 
state is good ('1'), we can forecast the next state according to 
the Ka-band channel model. Then, we forecast the third state 
due to the first two states. While forecasting the fourth state, 
the true value of the third can be determined because of the 
NAK feedback mechanism. We set the third state as the new 
initial state to predict the next two states. In this way, the so-
called two-step forecast is carried out. 
 
Figure 4.  State of channel forecasting theory according to Ka-band 
Step 1, When the file starts to transmit, the receiver records 
the error rate every time when the file reaches the 
74
Copyright (c) IARIA, 2012.     ISBN:  978-1-61208-194-6
SPACOMM 2012 : The Fourth International Conference on Advances in Satellite and Space Communications

earth. According to the error rate at this moment, 
the receiver can estimate the weather condition: a 
good state denoted by 1 and a bad state denoted by 
0. 
Step 2, condition-forecasting model is worked by the written 
'0' or '1' into the received words of the NAK, and 
the sender could get this weather condition when 
the NAK reaches Mars. 
Step 3, when the sender receives the NAK with the value '1', 
it judges that the weather condition is good, 
otherwise bad, as is shown in Figure 5. 
 
Figure 5.  The condition-forecast flow chart 
B. Error Analysis 
According to the GE channel model mentioned above, 
the steady probability can be attained when the probability 
of good weather is
G
P and that of bad is
B
P  If the initial 
state is bad('0')，one-step prediction error probability is  

0
2
(1
)
e
B
P
B





Similarly, when the initial state is good ('1'), one-step 
prediction error probability is　 

1
2
(1
)
e
G
P
G





So, the sum of the one-step prediction probability is 
0
error
B
e
G
e
P
P
P
P
P 1





The two-step state transition matrix is 
2
2
2
2
2
(1
)
2
2
(1
)
G
G
B
G
G
G
B
B
G
B
B
G
B
P
B

 


 


 

 






 










Similarly, two-step prediction probability is   
'
2
2
2
2(2
)[(1
)
]
2[(1
)
](2
)
error
B
B
B
G
B
B
G
B
G
G
G
B
G
G
G
B
P
P
P
2


 

 

 


 













Implement of the Forecasting Algorithm  
C. 
CFDP NAK [2] packet format originally has reserved 3-
bit (as shown in Figure 6).  The reserved words can be used 
to carry the value of the initial state of the two-step 
prediction. Selecting the first reserved word, when the 
initial state is good, the value '1' will be written, otherwise 
we will write '0'. 
V
e
r
e
i
o
n
3
P
D
U
T
Y
P
e
1
D
i
r
e
c
t
i
o
n
1
T 
r
a 
n
s 
m 
i 
s 
s
i 
o 
n 
M
o
d
e
1
R
e
s
e
r
v
e
d
C
R
C
F
l
a
g
1
1
PDU Data
Field
Length
16
R
e
s
e
r
v
e
d
1
L
E
n
g
t
h
o
f
e
n
t
i
t
y
I
D
s
3
R
e
s
e
r
v
e
d
1
T
r
a
n
s
s
e
q
n
m
b
r
l
n
g
t
h
3
Var.
Source entity ID
Transaction 
Seq.numbr
Destination 
entity ID
PDU
Data
Field
 
Figure 6.  Fixed PDU header of CFDP 
IV. 
DESIGN OF SELECTION-WAITING CFDP 
According to the analysis of the predictive model about 
the 
Ka-band 
channel, 
the 
selection-waiting 
CFDP 
mechanism is chosen to overcome shortcomings in the light 
of the change of the weather conditions (as is shown in 
Figure 7). 
 
Figure 7.  Selection-waiting CFDP transmission mechanism 
TABLE Ⅰ NOTATION 
Symbol 
Definition 
W 
Total File Delivery Time 
75
Copyright (c) IARIA, 2012.     ISBN:  978-1-61208-194-6
SPACOMM 2012 : The Fourth International Conference on Advances in Satellite and Space Communications

T 
Once-Waiting Time  
Tprop 
One-way propagation delay 
Tinc 
Transmission Detection Time at 
First Time 
Tdef 
Time of Retransmission 
Pe 
Bit Error Rate 
PePDU 
Pocket-loss-rate of PDU 
PeEOF 
Pocket-loss-rate of EOF 
LPDU 
Length of PDU 
TACK(EOF) 
Transmission Time of ACK(EOF) 
    Based on the tow-step forecasting of NAK, when the 
channel condition is good, the sender transmits the file to 
the receiver normally. However, when the channel is bad, 
the sender will make the following judgments: (1) if the 
time of the file-transmission time>T(20min), it will wait for 
the time value of T, and then transmit sequentially；(2) if 
the time of the file-transmission time<T, it transmits the file 
directly.  
The relationship between the pocket-loss-rate of PDU 
and the bit error rate is 
1
(1
) PDU
L
ePDU
e
P


 P
P

The pocket-loss-rate of the EOF is 
1
(1
) EOF
L
eEOF
e
P




The time value of the EOF timer is set as 
(
)
_
2 prop
ACK EOF
time
EOF
T
T



The mathematical expectation of the transmission of EOF 
is　 
e
(
P
(2
)
(
)
1
PDU
prop
EOF
ACK EOF
ePDU
prop
EOF
T
T
T
E EOF
P
T
T






)

We can get the Transmission Detection Time at first time is  
(
)
(
)
(
)
(
)
(2
)
1
inc
PDU
ACK EOF
ePDU
prop
EOF
ACK EOF
PDU
ePDU
prop
EOF
ACK EOF
T
NT
E EOF
T
P
T
T
T
NT
P
T
T
T












The time value of NAK is　　 
_
2
i
prop
i
time
NAK
T
R



and，　 
1
1
(
)
(1
N
M
i
PDU
i
ePDU
E
R
NT
P




1)

]
T
V. 

1
(
)
1
[1
(1
)
m
N
N
ePDU
m
E M
P








The time of retransmission at ith  time is 
2
,
_
2
,
_
i
i
pdu
prop
def
i
pdu
prop
n
T
T
good
weather
T
n
T
T
T bad
weather





 






So the time of retransmission is 　 
1
N
i
M
def
def
i
T

 

And the total of file delivery time is　 
inc
def
W
T
T



SIMULATION AND DISCUSSION 
The Earth-to-Mars communication is taken as an 
example to testify the rationality of selection-waiting CFDP 
proposed in this paper. Some experiments parameters are 
shown in Table Ⅱ and Table Ⅲ. 
TABLE Ⅱ PARAMETERS IN SIMULATION 
Parameters 
Parameters Descriptions 
Value 
Pe 
Bit-error-rate of Direct Point-
to-point Communication 
Between Mars and Earth 
10-4、10-5、 
10-6、10-7、10-8 
Tx(kb/s) 
Transmission Rate 
200 
N 
Number of PDUs 
105、2*105... 
Lpdu(Kbyte) 
Length of PDU 
2 
d(km) 
The Distance between Mars 
and Earth 
4×108 
TABLE Ⅲ VALUE OF TRANSITION MATRIX 
transition 
probability 
Sampling by 
averaging 
Sampling by 
choosing the 
max 
Sampling by 
choosing the 
min 
P(G/G) 
0.9773 
0.9656 
0.9853 
P(B/G) 
0.0227 
0.0344 
0.0147 
P(G/B) 
0.1667 
0.1618 
0.1799 
P(B/B) 
0.8333 
0.8382 
0.8201 
Figure 8 compares the performance of selection-waiting 
CFDP and traditional CFDP as the numbers of PDU varies 
from 1x105 to 1x106 under different bit error rates. The 
results show that the file delivery time of both selection-
waiting CFDP and the traditional CFDP increases in line 
ratio as the number of PDU increase. Apparently, as the bit-
error-rate decreases, the file delivery times both increase 
based on two CFDPs. In Figure 8, the performance of CFDP 
with weather-forecasting mechanism is better than that of 
the Gilbert-Elliot channel. It is said that Selection-waiting 
CFDP could reduce approximately 5x103s time at least, 
compared with the traditional CFDP. As the result, it means 
that Selection-waiting CFDP is more applicable than that of 
76
Copyright (c) IARIA, 2012.     ISBN:  978-1-61208-194-6
SPACOMM 2012 : The Fourth International Conference on Advances in Satellite and Space Communications

the traditional CFDP in the space communication over Ka-
band heavily influenced by the weather conditions, which is 
significant for cutting down the transmission time for long-
distance space communication links such as the Earth-to-
Mars communication.   
1
2
3
4
5
6
7
8
9
10
x 10
5
1000
2000
3000
4000
5000
6000
7000
8000
9000
10000
11000
tne Number of PDUs
Expected File Delivery Time/s
The selection-waiting CFDP vs. The traditional CFDP
 
 
Pe=1e-8
Pe=1e-7
Pe=1e-6
Pe=1e-8
Pe=1e-7
Pe=1e-6
 
Figure 8.  The file delivery time of the selection-waiting CFDP vs. The 
traditional CFDP under the different bit-error-rates 
We choose the transition matrix which is sampling by 
averaging in above simulation. In fact, the transition 
probability from good to bad states can be derived by 
1/(average duration of good weather) and the transition 
probability from bad to good state is 1/(average duration of 
bad weather). The transition probabilities of different 
sampling methods with the threshold of 20K,are shown in 
the Table Ⅲ. These transition probabilities will be used for 
simulating weather patterns. 
VI. 
VII. 
CONCLUSION 
In this study, the weather-forecasting algorithm is 
presented to evaluate the CFDP performance under good 
and bad weather conditions, and a novel file delivery 
protocol, inserting the weather-forecasting algorithm into 
traditional direct point-to-point link, is proposed. Based on 
the condition-forecasting model eatablished, comprehensive 
experiments are carried out and discussed under different 
conditions of parameters involved in the proposed protocol. 
Results indicate that the proposed protocol perform much 
better than that of the traditional Deferred NAK CFDP in 
terms of file delivery time. 
Further work will consider the selection of transmission 
rate into the performance of the proposed protocol over Ka-
band. And another algorithm about the perception of 
channel will be proposed and will be compared with the 
protocol proposed in this work. 
ACKNOWLEDGMENT 
The authors gratefully acknowledge the detailed 
comments and suggestions of Professor Qinyu Zhang. This 
work has been supported by the National Natural Sciences 
Foundation-key project of China (NSFC) under Grant No. 
61032003 and the National Natural Science Foundation of 
China Youth Fund Project (No. 61102083). 
 
REFERENCES 
[1] 
CCSDS File Delivery Protocol (CFDP) Part 1: Introduction and 
Overview. CCSDS 720.1-G-3[EB/OL]. April 2007. http: // ccsds. org. 
pp. 20-30 
[2] 
CCSDS File Delivery Protocol (CFDP) Part 2: Implementers Guide. 
CCSDS 720.2-G-3[EB/OL]. April 2007. http: // ccsds. org. pp. 1-20  
[3] 
Lee D C, and Baek W. Expected file-delivery time of deferred NAK 
ARQ in CCSDS file-delivery protocol [J]. IEEE Transactions on 
Communications. 2004, 52(8): pp.1408-1416. 
[4] 
Ruhai W, Shrestha B L, and Xiaoli M. Channel Delay Impact on 
CCSDS File   Delivery Protocol(CFDP) over Space Communications 
Links[A].ICC'07[C]. Glasgow, U.K., 2007. pp. 5201-5205. 
[5] 
Ruhai W, Rudraraju D L, and Rapet P K V, et al. Performance 
Evaluation of CCSDS File Delivery Protocol (CFDP) in Deferred 
NAK mode over Geostationary Earth Orbit (GEO)-Satellite 
Links[A].ICC'07[C]. Glasgow, U. K., 2007. pp. 4421-4425. 
[6] 
Ruhai W, Shrestha B L, and Xuan W, et al. Experimental 
Investigation of CCSDS File Delivery Protocol (CFDP) over 
Cislunar 
Communication 
Links 
with 
Intermittent 
Connectivity.ICC'08.Beijing,China,2008. pp. 1910-1914. 
[7] 
Wang R H, Shrestha B L, and Wu X, et al. Unreliable CCSDS File 
Delivery Protocol (CFDP) over Cislunar Communication Links[J]. 
IEEE TRANSACTIONS ON AEROSPACE AND ELECTRONIC 
SYSTEMS. 2010, 46(1): pp. 147-169. 
[8] 
Sung I. U, and Jay L. Gao. “CFDP Performance over Weather-
Dependent Ka-band Channel”, in: Proceeding of SpaceOps 2006, Jun. 
AIAA-2006-5968 
 
77
Copyright (c) IARIA, 2012.     ISBN:  978-1-61208-194-6
SPACOMM 2012 : The Fourth International Conference on Advances in Satellite and Space Communications

