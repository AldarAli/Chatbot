Macropixel Compressive Sensing Reconstruction of Spectral Images Sensed by 
Multispectral Filter Array-based Sensors
Yuri H. Mejia, Fernando A. Rojas, and Henry Arguello 
Department of Systems Engineering and Computer Science  
Universidad Industrial de Santander 
Bucaramanga, Colombia 
email: yuri.mejia@correo.uis.edu.co, frojas@uis.edu.co, henarfu@uis.edu.co 
 
Abstract—Spectral images are 3 dimensional data cubes of 
spectral information from a two-dimensional spatial scene. 
Traditional acquisition of these data cubes includes complex 
architectures that involves the use of prisms, tunable filters, 
and tunable illumination. Technical progress has allowed 
developing MSFA-based sensors in order to extrapolate the 
reconstruction of more bands than RGB cameras. However, 
reconstructing 
the 
spectral 
images 
with 
traditional 
mathematical 
methods 
following 
a 
least 
squares 
or 
demosaicing approach is unfeasible. Recently compressive 
sensing 
technique 
has 
been 
developed 
that 
allows 
reconstructing signals with few measurements than the 
traditional methods by using the sparse representation of the 
underlying signal. It is possible to exploit the capabilities of 
MSFA-based sensors selecting measurements subsets to form 
macropixels that have spectral information of a single 
reconstructed pixel. The macropixel size selection leads to a 
variable reconstructed spatial resolution preserving the filters 
spectral resolution. This paper presents a model for spectral 
images reconstruction from macropixels formed with MSFA-
based sensor measurements using the principle of compressive 
sampling. This model selects subsets of the macropixels 
measurements following a downsampling matrix operation, 
therefore a reconstruction model is formulated by directly 
reconstruct a spectral image with the spectral resolution given 
by the number of filters. To verify the effectiveness of the 
reconstruction model measurements of the MSFA-based sensor 
for real spectral images are simulated. An ensemble of random 
dichroic filters is used. The macropixel compressive sensing 
reconstruction 
approach 
and 
the 
traditional 
scheme 
reconstruction are compared. 
Keywords- 
spectral 
images; 
MSFA-based 
sensors; 
compressive sensing; macropixel. 
I. 
 INTRODUCTION 
Spectral imaging involves the sensing of a scene where at 
every location of the image plane the spectral information is 
collected. Its applications are many and cover ocean 
research, food safety, geology, and medical demands. Some 
examples involve the characterization of phytoplankton in 
the ocean [1], quality evaluation in the area of food safety 
[2], plant stress assessment [3], characterization of different 
bacterial colonies [4], disease diagnosis, and image-guided 
surgery [5]. 
In some spectral imagers, the scene is beamsplit into the 
wavelength components for example using a prism 
assembly, and each of these images is captured in a separate 
detector array. In this method the sensing devices have 
significant size and weight disadvantages [6]. One of the 
most intuitive multispectral scanning techniques is the 
tunable filter, where a complete spectral image is produced 
after a sequence of exposures by capturing an image of one 
spectral band at time. For instance, the spectral image can be 
sensed by using a filter wheel where some optical filters are 
installed in a rotatory mechanical structure [7]. Most of the 
methods are related to scanning operations where multiple 
exposures are used causing motion artifacts. 
On the contrary, some techniques use MSFA and collect 
multiple wavelength spectra from a single detector array [8]. 
Nowadays, optical coatings technologies have been 
miniaturized and optimized such that the creation of multi-
patterned arrays of different optical filters, with traditional 
design and manufacturing methods, is allowed [6]. The 
optical coatings production methodology combines modern 
optical 
thin 
film 
deposition 
techniques 
with 
microlithographic procedures. This process enables micron-
scale precision patterning of optical thin film dichroic 
coatings on a single substrate. A dichroic filter is an accurate 
color filter used to selectively pass light of a small range of 
wavelengths while reflecting other wavelengths. 
Figure 1 shows a representation of a MSFA-based sensor 
that is a monochrome image sensor covering with a MSFA, 
each pixel in the sensor is measuring only some spectral 
components at a specific spatial location. Since there are 
only some wavelength elements available in each pixel, the 
missing wavelength elements must be estimated from the 
adjacent pixels. This process is called multispectral 
demosaicing, and in most cases is carried out depending on 
the specific acquisition process.  
A ﬁlter in the MSFA
Image sensor 
(monochrome)
 
Figure 1.  A MSFA-based sensor is illustrated.  
For example, Miao et al. [9] generate a MSFA following 
a binary tree-based method, which starts from a 
checkerboard pattern. By recursively separating the original 
checkerboard, the algorithm generates the MSFA given the 
number of spectral bands and the probability of appearance 
of each band. Then, they design a demosaicing algorithm 
based on the same binary tree. Brauers and Aach [10] 
propose a MSFA that consists of color filter blocks of the 
158
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-426-8
SENSORDEVICES 2015 : The Sixth International Conference on Sensor Device Technologies and Applications

size 3×2 pixels, this configuration allows to use a fast 
bilinear interpolation with a reconstruction up to 6 spectral 
bands. Monno et al. [11] propose a five-band MSFA. In the 
pattern, the green-like channel is distributed as in the Bayer 
color filter array (CFA), and other channels are arranged 
following a binary-tree approach. For demosaicing an 
adaptive kernel can be estimated directly from the raw data. 
Common to these systems is that the MSFA design is 
application and number of bands dependent, which reach at 
most 6.  
On the other hand, Compressive Sensing (CS) has 
emerged as a rising research area that allows the acquisition 
of signals at sampling rates below the Nyquist-criterion. In 
CS traditional sampling is substituted by measurements of 
random projections of the signal. The signals are then 
reconstructed by solving an l1 and l2 minimization problem 
in a basis where admits sparse representations. CS exploits 
the fact that hyperspectral images can be sparse in some 
basis representation.  
Mathematically, a multispectral image 
N N L
F∈ℜ × ×
 in 
its vector representation
f ∈ℜM
 with M=N2L, can be 
expressed as f=Ψθ, where θ  is the coefficients sequence of 
S elements that represents f, with S<<M, and Ψ is a 
representation basis. Here, N×N represents the spatial 
dimensions, and L the number of spectral bands in the data 
cube. Compressive sensing allows f recovering from m 
random projections when m ≥ S log (M) << M. 
Assuming that the MSFA-based sensor performs a linear 
measurement process that calculate m<<M internal products 
between f and a collection of vectors {Hj}j=1
m, as 
,
,
j
iy
f H
=
then y=Hf, where the set of yi projections 
form the vector y of m elements, H is the measurement 
matrix with dimensions m×M, with Hj
T rows, and f is the 
original signal of size M. For recovering f from y, there exist 
infinite solutions due to the size of y is much less than the 
size of f.  
Following the sparse representation of the signal and the 
MSFA-based sensor, measurements can be expressed as 
y=Hf =HΨθ=Aθ, where 
A = HΨ∈ℜm×M
is the sensing 
matrix. This underdetermined equation system can be 
solved if it is satisfied that the measurement matrix H is 
incoherent with the sparse transformation Ψ. It is possible 
to exploit the capabilities of MSFA-based sensors selecting 
measurements subsets to form macropixels that have 
spectral information of a single reconstructed pixel. That is, 
spectral information of a single pixel can be reconstructed 
based on macropixel measurements. The macropixel size 
selection leads to a variable reconstructed spatial resolution 
preserving the filters spectral resolution, reconstructing a 
spatial decimated data cube. This information can be used in 
applications requiring higher spectral than spatial image 
quality, also for a quick view of the scene, for example for 
purposes of transmission and communication applications 
This paper presents a model for spectral images 
reconstruction from macropixels formed with MSFA-based 
sensor measurements using the principle of compressive 
sampling. This model selects subsets of the macropixels 
measurements following a downsampling matrix operation, 
therefore a reconstruction model is formulated by directly 
reconstruct a spectral image of variable spatial resolution. 
The maximum spatial resolution is limited by the detector 
resolution. The number of different filters limits the spectral 
resolution. 
The 
data 
cube 
is 
then 
reconstructed 
as 
),
(argmin
~
1
2
+τ θ
−
=
θ
y
f
θ
H Ψ
Ψ 
S
 where 
y 
is 
the 
measurement selection, HS is the measurement matrix 
defined as 
H,
D
D
H
T T
q
T
S
) ]
) ...(
[(
1
0
2 −
=
where 
ℓ
D  is the ℓ th 
downsampling matrix used for measurement selection, θ is 
an S-sparse representation of a low resolution version of f 
on the basis Ψ, and τ is a regularization constant. 
The rest of this paper is organized as follows. Section II 
describes the mathematical model of the spectral image 
acquisition system using MSFA-based sensors. Section III 
describes the traditional demosaicing process. Section IV 
addresses the macropixel CS reconstruction approach. 
Section V describes the mathematical model of the dichroic 
filters. Section VI shows the simulation results. The 
conclusion closes the article. 
II. 
SPECTRAL IMAGE ADQUISITION 
To analyze the sensor-MSFA system its functions are 
modeled following the physical sensing phenomena for L=6 
spectral bands and focusing in the jth-slice in Figure 2. First, 
the MSFA T(x, y, λ) modulates the spatial-spectral data cube 
f0(x, y, λ), resulting in the coded field f1(x, y, λ), where (x, y) 
are the spatial coordinates, and λ is the wavelength. Then the 
coded density impacts on the sensor.  
λ0
λ5
N
L
 
 
 
 
 
 
Data Cube
1st 
Slice 
jth 
Slice 
 
 
Sensor
 
 
 
 
 
 
 
Row 1
Row jth
Row N
 
 
 

Spatial
Spectral
N
N
Multispectral 
ﬁlter array
Coded ﬁeld
N
T(x, y,λ)
f0(x, y,λ)
f1(x, y,λ)
 
Figure 2.  Sensing phenomena representation of the MSFA-based sensor. 
The jth slice of the data cube is coded by a row of the MSFA. 
The coded density integrated into the detector can be 
expressed as 
,'
'
)
, '
) ( '
,'
( ,'
)
,'
( ,'
( , , )
1
2
∫∫
−
−
=
y dx dy
h x x y
f x y
T x y
x y
f
λ
λ
λ
 
(1) 
where 
)
,'
( ,'
T x y λ
is the transmission function representing 
the MSFA, and 
)
, '
( '
y
h x x y
−
−
 is the optical response of the 
system.  
Each pixel in the sensor is a discretized measurement. 
The source f0(x, y, λ) can be written in discrete form as 
F i, k j,
 
159
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-426-8
SENSORDEVICES 2015 : The Sixth International Conference on Sensor Device Technologies and Applications

where i and j index the spatial coordinates, and k determines 
the kth spectral plane. Let Ti,j,k ∈ {0,1} be the discretization of 
the MSFA. 
Then, the discretized MSFA-based sensor measurements 
can be expressed as 
∑
−
=
+
=
1
0
,
, ,
, ,
,
L
k
i j
i j k i j k
i,j
T
F
Y
ω
 
(2) 
where Yi,j is the intensity at the (i, j)th position of the detector, 
i, j=0, 1, …, N-1, and the dimensions of the detector are 
N×N. F is an N×N×L spectral data cube, and ωi, j is the white 
noise of the sensing system. 
The measurements Yi,j in (2) can be written in matrix 
notation as 
y=Hf+ω, 
(3) 
where y is an N2-long vector representation of Yi,j, f=vect([f0, 
…, fL-1]) is the vector representation of the data cube F 
where fk is the vectorization of the kth spectral band.  
The output y in (3) can be extended as 
[
]
,
)
diag(
)
(
diag
1
1
0
1
0
ω
+
⎥
⎥
⎥
⎥
⎥
⎦
⎤
⎢
⎢
⎢
⎢
⎢
⎣
⎡
=
−
−
L
L
f
f
f
y
!
"
"""
#
"
"""
$
%
&
H
t
t
 
(4) 
where 
kt is the vectorization of the kth MSFA spectral plane, 
diag(tk) is an N2×N2 diagonal matrix whose entries are tk, 
more specifically ( )
⎣
⎦
⎣
⎦
i N N k
i N i
k i
T
,
/
,
/
−
=
t
for i=0, …, N2-1. 
Figure 3 depicts a random MSFA based matrix H for N=6, 
and L=4. Colored squares represent unblocking light 
elements related to a specific wavelength.  
  
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
!!
N2 (1st band)
N2 (2nd band)
N2 (3rd band)
N2 (4th band)
diag(t0)
diag(t1)
diag(t2)
diag(t3)
N2
 
!!
!!
!!
!!
!!
Block
Pass λ0
Pass λ1
Pass λ2
Pass λ3
 
Figure 3.  The matrix H is shown for N=6, and L=4. Colored squares 
represent unblocking light elements related to a specific wavelenght. 
III. 
TRADITIONAL DEMOSAICING 
Given the set of measurements y a traditional 
demosaicing algorithm estimates for each reconstructed pixel 
the intensities for all wavelength components. Common 
approach minimizes the linear mean square error between 
the measurements and the vector estimation multiplied by 
the sensing matrix, that is  
,
argmin
~
f 2
y -
f
f
H
=
 
(5) 
A closed-form solution to (5) is given by  
(
)
y,
y
f
+
−
=
=
H
H
H
H
T
T
1
~
 
(6) 
where H+ is known as the pseudoinverse of H, and HT is its 
transpose. For comparison purpose, this approach is 
implemented.  
Also, for the spatial resolution variation of the data cube 
an average decimation matrix is applied to the reconstructed 
data cube. The variable q is defined as the macropixel side 
size; each macropixel in a spectral band is a block of 
dimensions q×q pixels, where the ratio N/q is an integer. The 
decimated reconstruction is given by
,f
f
~
~
q = D
 where D does 
a block averaging of size q×q in each spectral band reducing 
the size of the vectorized reconstructed data cube to 
.1
2 ×
q
L
N 2
  
The spatial decimation matrix element-by-element can be 
expressed as:  
otherwise,
,
if
,0
,
1
2
,
⎥⎦
⎥
⎢⎣
⎢
+
⎥⎦
⎥
⎢⎣
⎢
−
⎥⎦
⎥
⎢⎣
⎢
=
⎪⎩
⎪⎨
⎧
=
qN
j
q
N
N
j
q
N
q
j
i
q
Di j
 
(7) 
where 
,1
,
,1,0
2
−
=
q
N L
i
2
!
and j=0,1,…, N2L-1.  
IV. 
MACROPIXEL COMPRESSIVE SENSING 
RECONSTRUCTION 
In this model, the macropixel definition is based on the 
assumption that q×q neighboring pixels, in an N×N×L 
spectral image, could have a similar spectral response, Figure 
4 illustrates this premise. Then, the macropixel, which is 
formed of q×q measurement pixels in the sensor, is taken as 
the spectral response of a single pixel for a decimated 
reconstruction. For instance, Figure 5 shows an example of 
the measurement selection for a macropixel side size of q=2. 
In total are taken q2 subsets of measurements in a single shot 
of the MSFA-based sensor.  
L
N
N
q
q
 
Figure 4.  Illustration of the assumption that for q×q  neighboring pixels, 
in a N×N×L spectral image, the spectral response is simillar. 
In the acquisition model, the matrix product between a 
downsampling matrix and the total sensor measurements 
forms each subset of measurements. More specifically, each 
subset is given by  
,f
y
ℓ = DℓH
 
(8) 
where 
ℓ
D  does a downsampling in each q×q square of pixels 
for taken q2 different subsets of the total measurements, and 
ℓy
 is 
the 
htℓ
 subset 
of 
measurements 
where 
}.
1
{ ,0
2 −
∈
!q
ℓ
 Figure 5 shows an example of a subset 
measurement selection for q=2. Precisely, the function of the 
decimation matrix 
ℓ
D  is selecting in each q×q block of the 
measurements the 
htℓ
-element for forming the 
htℓ
-subset of 
160
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-426-8
SENSORDEVICES 2015 : The Sixth International Conference on Sensor Device Technologies and Applications

measurements. The decimation matrix element-by-element 
can be expressed as:  
⎪⎩
⎪⎨
⎧
−
⎥⎦
⎥
⎢⎣
+ ⎢
+
⎥⎦
⎥
⎢⎣
⎢
−
+
=
=
otherwise,
,0
),
(
)1
(
if 
,1
,
q
N
q
N
N iq
q
iq
j
j
i
ℓ
ℓ
Dℓ
 
(9) 
where 
,1
2
,
,1,0
−
=
q
N
i
2
!
j=0,1,…,N2-1, and 
.1
,
,1,0
2 −
=
… q
ℓ
 
Figure 6 depicts the downsampling matrix 
ℓ
D  for q=2, N=6, 
and
.3
,2
,1,0
ℓ =
The white squares represent one-valued 
elements. 
In this case, the complete set of measurements is given 
by 
f,
f
D
D
D
y
y
y
y
S
q
q
H
H
=
⎥
⎥
⎥
⎥
⎥
⎦
⎤
⎢
⎢
⎢
⎢
⎢
⎣
⎡
=
⎥
⎥
⎥
⎥
⎥
⎦
⎤
⎢
⎢
⎢
⎢
⎢
⎣
⎡
=
−
−
1
1
0
1
1
0
2
2
!
!
 
(10) 
where subjacent data cube projection is reconstructed solving 
an l1 and l2 minimization problem, where the decimation 
process is taken into account. The optimization problem is 
given by 
),
(argmin
~
1
2
θ
θ
y
f
θ
+τ
−
=
H Ψ
Ψ 
S
where y is 
given by (10), HS is the measurement matrix defined as 
H,
D
D
H
T T
q
T
S
) ]
) ...(
[(
1
0
2 −
=
 θ is an S-sparse representation 
of a low resolution version of f on the basis Ψ, and τ is a 
regularization constant [12]. 
HS 
is 
the 
measurement 
matrix 
defined 
as 
H,
D
D
H
T T
q
T
S
1) ]
2
[( 0) ...(
−
=
where 
Dℓ
 is 
the 
th
ℓ  
downsampling matrix used for measurement selection, θ is 
an S-sparse representation of a low resolution version of f 
on the basis Ψ, and τ is a regularization constant. 
 
y0
y1
0
y1
1
y1
3
y1
2
1st subset of 
measurements
2nd subset of 
measurements
3rd subset of 
measurements
4th subset of 
measurements
y1
y2
y3
N
N
q
q
A macropixel 
 
Figure 5.  Example of a subset selection for a macropixel size of q×q = 
2×2 that forms 4 subsets of measurements in a single shot of the MSFA-
based sensor. 
N
N2
N
N2
q2!
l =0
N2
N2
q2!
l =1
l =2
l =3
N
N2
N2
q2!
N
N2
N2
q2!
 
Figure 6.  The downsampling matrix 
Dℓ
is shown for q=2, N=6 and 
.3
,2
,1,0
ℓ =
White squares represent ones and the black elements are 
zero. 
V. 
MULTISPECTRAL FILTERS  
For developing this work random dichroic filters were 
used. Dichroic filters let pass only one spectral band for each 
sensor pixel. Then, the spectral response for pixel can be 
selected randomly from a set of spectral bands. The spectral 
response of the 
)
(
iλD
dichroic filter pixel can be defined as  
⎪⎩
⎪⎨
⎧
=
=
otherwise,
,0
,
if 
,1
)
(
D
i
i
k
k
λ
t
 
(12) 
for the random variable  
1},
{0,...,
−
∈
L
iλD
the ith filter where 
i=0,…,N2-1, and k=0,…,L-1. For example, the first pixel of 
a MSFA of L=5 spectral bands can have the spectral 
response (tk)1=[0 1 0 0 0], where the random variable is 
.2
iλD =
 
VI. 
SIMULATION AND RESULTS 
To verify the macropixel CS reconstruction of spectral 
images sensed by MSFA-based sensors, a set of compressive 
measurements is simulated using the model of (2). These 
measurements are constructed employing the Beads spectral 
image captured with a CCD camera Apogee Alta U260 and a 
VariSpec liquid crystal tunable filter, in the range of 
wavelength 400nm-560nm, with steps of 10nm [13]. The 
resulting test data cube F has 512×512 pixels of spatial 
resolution and L=16 spectral bands. The RGB image mapped 
version of the data cube is shown in Figure 7. An ensemble 
of dichroic filters based on a random selection of spectral 
bands is used. Compressive sensing reconstruction is 
realized using the GPSR algorithm [14]. The representation 
basis Ψ is a Kronecker product Ψ=Ψ1⊗Ψ2, where Ψ1is the 
two-dimensional-wavelet Symmlet-8 basis and Ψ2 is the 
cosine basis. The simulations are performed in a desktop 
architecture with an Intel Core i7 3.6GHz processor, 32GB 
RAM, and using Matlab R2014a. 
λ1#
λ2#
A
B
 
Figure 7.  Multispectral image Beads used in simulations (false RGB 
color). 
161
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-426-8
SENSORDEVICES 2015 : The Sixth International Conference on Sensor Device Technologies and Applications

A. Variation of the macropixel side size q 
Figure 8 depicts the PSNR of the reconstructed images as 
a function of the macropixel side size q, for q∈{1,2,4,8}. 
Figure 8(a) shows the results when L=3 spectral bands are 
sensed and reconstructed. Figure 8(b) for L=8, Figure 8(c) 
for L=12, and Figure 8(d) for L=16. The PSNR comparison 
is made between the reconstructed image and a spatial 
decimated version (of size N/q×N/q×L) of the test data cube. 
Results show that increasing spectral bands decreases the 
PSNR for both reconstruction methods. Furthermore, 
increasing the size of q improves the macropixel CS 
reconstruction results more than the traditional demosaicing 
results.  
q (macropixel side size)
2
4
6
8
PSNR
26
28
30
32
34
Macropixel CS
Traditional
 
q (macropixel side size)
2
4
6
8
PSNR
22
24
26
28
30
Macropixel CS
Traditional
 
(a) 
(b) 
q (macropixel side size)
2
4
6
8
PSNR
20
22
24
26
28
Macropixel CS
Traditional
 
q (macropixel side size)
2
4
6
8
PSNR
20
22
24
26
28
Macropixel CS
Traditional
 
(e) 
(f) 
Figure 8.  Mean PSNR of the reconstructed data cubes as a function of the 
macropixel side size q, where L spectral bands are sensed and 
reconstructed, for (a) L=3, (b) L=8, (c) L=12, and (d) L=16. 
Figure 9(a) shows a zoomed version of a selected region 
of the original 2nd spectral band (this region is highlighted in 
Figure 7 where λ1=2). Figure 9 (b) shows its reconstruction 
when the first L=3 spectral bands are sensed and 
reconstructed using the macropixel CS approach for q=1. 
Figure 9(c) illustrates its reconstruction for the traditional 
demosaicing method. Figure 9(d) depicts reconstruction 
along the spectral axis of the spatial pixel location A of the 
Figure 7, where the intensity is normalized between 0-1. 
Figure 9 (e)-(h) show similar results for the 3rd spectral band 
and the second region highlighted in Figure 8 for λ2=3. 
There, it is possible to observe for L=3 spectral bands the 
traditional demosaicing has a comparable performance with 
the macropixel CS reconstruction (around 26 dB in PSNR 
for both approaches) for q=1 macropixel side size. 
 
 
 
L (spectral band)
1
2
3
Normalized intensity
0.2
0.4
0.6
0.8
1
Groundtruth
Complete CS
Traditional
 
(a) 
(b) 
(c) 
(d) 
 
 
 
 
L (spectral band)
1
2
3
Normalized intensity
0.2
0.4
0.6
0.8
1
Groundtruth
Complete CS
Traditional
 
(e) 
(f) 
(g) 
(h) 
Figure 9.  Zoom version of the reconstructions results when L=3 spectral 
bands are sensed and reconstructed, for q=1. For the spectral band λ1=2: (a) 
groundtruth, (b) reconstruction by macropixel CS, (c) reconstruction by a 
traditional approach, and (d) reconstruction along the spectral axis of the 
spatial pixel location A in the Fig. 8. For the spectral band λ2=3: (e) 
groundtruth, (f) reconstruction by macropixel CS, (g) reconstruction by a 
traditional approach, and (h) reconstruction along the spectral axis of the 
spatial pixel location B of the Fig. 8. 
Figure 11 shows similar result to those of Figure 10 for 
q=4, and L=3. Also, in this case it is possible to observe the 
better performance of the macropixel CS approach where a 
PSNR improvement of up to 4 dB is attained for q=4 
macropixel side size compared with the traditional approach.  
  
 
 
 
L (spectral band)
1
2
3
Normalized intensity
0.2
0.4
0.6
0.8
1
Groundtruth
Complete CS
Traditional
 
(a) 
(b) 
(c) 
(d) 
 
 
 
 
L (spectral band)
1
2
3
Normalized intensity
0.2
0.4
0.6
0.8
1
Groundtruth
Complete CS
Traditional
 
(e) 
(f) 
(g) 
(h) 
Figure 10.  Zoom version of the reconstructions results when L=3 spectral 
bands are sensed and reconstructed, for q=4. For the spectral band λ1=2: (a) 
groundtruth, (b) reconstruction by macropixel CS, (c) reconstruction by a 
traditional approach, and (d) reconstruction along the spectral axis of the 
spatial pixel location A in the Fig. 8. For the spectral band  λ2=3: (a) 
groundtruth, (b) reconstruction by macropixel CS, (c) reconstruction by a 
traditional approach, and (d) reconstruction along the spectral axis of the 
spatial pixel location B in the Fig. 8. 
Figure 12 (a) shows the selected region of the original 3rd 
spectral band (in Figure 7 where λ1=3). Figure 12 (b) shows 
its reconstruction when the first L=8 spectral bands are 
sensed and reconstructed using the macropixel CS approach 
for q=1. Figure 12 (c) illustrates its reconstruction for the 
traditional demosaicing method. Figure 12 (d) depicts 
reconstruction along the spectral axis for location A. Figure 
12 (e)-(h) show similar results for the 8th spectral band and 
the second region highlighted in Figure 8 for λ2=8. The 
performance of the macropixel CS approach has a PSNR 
improvement of up to 2 dB for q=1 macropixel side size 
compared with the traditional demosaicing approach.  
 
162
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-426-8
SENSORDEVICES 2015 : The Sixth International Conference on Sensor Device Technologies and Applications

 
 
 
L (spectral band)
4
6
8
Normalized intensity
0
0.2
0.4
0.6
Groundtruth
Complete CS
Traditional
 
(a) 
(b) 
(c) 
(d) 
 
 
 
 
L (spectral band)
4
6
8
Normalized intensity
0
0.2
0.4
0.6
Groundtruth
Complete CS
Traditional
 
(e) 
(f) 
(g) 
(h) 
Figure 11.  Zoom version of the reconstructions results when L=8 spectral 
bands are sensed and reconstructed. For the spectral band λ1=3: (a) 
groundtruth, (b) reconstruction by macropixel CS for q=1, (c) 
reconstruction by a traditional approach, and (d) reconstruction along the 
spectral axis of the spatial pixel location A of the Fig. 8. For the spectral 
band λ2=8: (a) groundtruth, (b) reconstruction by macropixel CS for q=1, 
(c) reconstruction by a traditional approach, and (d) reconstruction along 
the spectral axis of the spatial pixel location B of the Fig. 8. 
Figure 13 shows similar result to those of Figure 12 for 
q=4, and L=8. Also, it is possible to observe the better 
performance of the macropixel CS approach where a PSNR 
improvement of up to 5.7 dB is attained for q=4 macropixel 
side size compared with the traditional approach. For all 
cases the macropixel CS approach has a better spectral 
signature reconstruction than the traditional demosaicing. 
 
 
 
L (spectral band)
4
6
8
Normalized intensity
0
0.2
0.4
0.6
Groundtruth
Complete CS
Traditional
 
(a) 
(b) 
(c) 
(d) 
 
 
 
 
L (spectral band)
4
6
8
Normalized intensity
0
0.2
0.4
0.6
Groundtruth
Complete CS
Traditional
 
(e) 
(f) 
(g) 
(h) 
Figure 12.  Zoom version of the reconstructions results when L=8 spectral 
bands are sensed and reconstructed, for q=4. For the spectral band λ1=3: (a) 
groundtruth, (b) reconstruction by macropixel CS, (c) reconstruction by a 
traditional approach, and (d) reconstruction along the spectral axis of the 
spatial pixel location A in the Fig. 8. For the spectral band λ2=8: (a) 
groundtruth, (b) reconstruction by macropixel CS, (c) reconstruction by a 
traditional approach, and (d) reconstruction along the spectral axis of the 
spatial pixel location B in the Fig. 9. 
VII. CONCLUSION 
A model for macropixel CS reconstruction of spectral 
images sensed by MSFA-based sensors is presented. A 
selection of measurements subsets to form macropixels that 
have spectral information of a single reconstructed pixel is 
exposed. The macropixel CS reconstruction approach is 
compared with a traditional least squares reconstruction. For 
the macropixel CS reconstruction, the PSNR increases 
rapidly with the macropixel side size. For instance, the 
improvements range from 1 dB to 6 dB with respect to the 
traditional approach. Results show that increasing spectral 
bands decreases the PSNR for both reconstruction methods.  
REFERENCES 
[1] 
J. Ryan, C. Davis, N. Tufillaro, R. Kudela, and B.-C. Gao, 
“Application of the Hyperspectral Imager for the Coastal Ocean 
to Phytoplankton Ecology Studies in Monterey Bay, CA, USA,” 
Remote Sens., vol. 6, no. 2, Jan. 2014, pp. 1007–1025. 
[2] 
Z. Xiong, A. Xie, D.-W. Sun, X.-A. Zeng, and D. Liu, 
“Applications of Hyperspectral Imaging in Chicken Meat Safety 
and Quality Detection and Evaluation: A Review.,” Crit. Rev. 
Food Sci. Nutr., Apr. 2014, pp. 1287-1301. 
[3] 
G. J. Bellante, S. L. Powell, R. L. Lawrence, K. S. Repasky, and 
T. a. O. Dougher, “Aerial detection of a simulated CO2 leak from 
a geologic sequestration site using hyperspectral imagery,” Int. J. 
Greenh. Gas Control, vol. 13, Mar. 2013, pp. 124–137. 
[4] 
M. Mehrübeoglu, G. W. Buck, and D. W. Livingston, 
“Differentiation of bacterial colonies and temporal growth 
patterns using hyperspectral imaging,” in SPIE Optical 
Engineering + Applications, 2014, p. 922206. 
[5] 
G. Lu and B. Fei, “Medical hyperspectral imaging: a review.,” J. 
Biomed. Opt., vol. 19, no. 1, Jan. 2014, p. 10901. 
[6] 
J. D. Barrie, K. a. Aitchison, G. S. Rossano, and M. H. Abraham, 
“Patterning of multilayer dielectric optical coatings for 
multispectral CCDs,” Thin Solid Films, vol. 270, no. 1–2, Dec. 
1995, pp. 6–9. 
[7] 
Z. Frentress, L. C. Young, and H. D. Edwards, “Field Photometer 
with Nine-Element Filter Wheel,” Appl. Opt, vol. 3, 1964, pp. 
303–309. 
[8] 
P. J. Lapray, X. Wang, J. B. Thomas, and P. Gouton, 
“Multispectral Filter Arrays: Recent Advances and Practical 
Implementation,” Sensors, vol. 14, 2014, pp. 21626–21659. 
[9] 
L. Miao, H. Qi, R. Ramanath, and W. E. Snyder, “Binary tree-
based generic demosaicking algorithm for multispectral filter 
arrays,” IEEE Trans. Image Process., vol. 15, no. 11, 2006, pp. 
3550–3558. 
[10] 
J. Brauers and T. Aach, “A Color Filter Array Based 
Multispectral Camera,” 12 Work. Farbbildverarbeitung, 2006. 
[11] 
Y. Monno, M. Tanaka, and M. Okutomi, “Multispectral 
Demosaicking Using Adaptive Kernel Upsampling,” in In 
Proceedings of the 18th IEEE International Conference on Image 
Processing (ICIP), 2011, pp. 3218–3221. 
[12] 
H. Arguello and G. R. Arce, “Colored coded aperture design by 
concentration of measure in compressive spectral imaging.,” 
IEEE Trans. Image Process., vol. 23, no. 4, Apr. 2014, pp. 1896–
908. 
[13] 
S. K. N. F. Yasuma, T. Mitsunaga, and D. Iso, “CAVE | Projects: 
Multispectral Image Database,” Generalized Assorted Pixel 
Camera: Post-Capture Control of Resolution, Dynamic Range 
and 
Spectrum. 
[Online]. 
Available: 
http://www.cs.columbia.edu/CAVE/databases/multispectral/. 
[Accessed: 24-Feb-2015]. 
[14] 
M. A. Figueiredo, R. D. Nowak, and S. J. Wright, “Gradient 
projection for sparse reconstruction: Application to compressed 
sensing and other inverse problems.,” Sel. Top. Signal Process. 
IEEE J., vol. 1, no. 4, 2007, pp. 586–597.  
 
163
Copyright (c) IARIA, 2015.     ISBN:  978-1-61208-426-8
SENSORDEVICES 2015 : The Sixth International Conference on Sensor Device Technologies and Applications

